window.DOMHandler=class{constructor(b,a){this._iRuntime=b;this._componentId=a;this._hasTickCallback=!1;this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(b,a,c,d){this._iRuntime.PostToRuntimeComponent(this._componentId,b,a,c,d)}PostToRuntimeAsync(b,a,c,d){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,b,a,c,d)}_PostToRuntimeMaybeSync(b,a,c){this._iRuntime.UsesWorker()?this.PostToRuntime(b,a,c):this._iRuntime._GetLocalRuntime()._OnMessageFromDOM({type:"event",component:this._componentId,
handler:b,dispatchOpts:c||null,data:a,responseId:null})}AddRuntimeMessageHandler(b,a){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,b,a)}AddRuntimeMessageHandlers(b){for(const [a,c]of b)this.AddRuntimeMessageHandler(a,c)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&(this._iRuntime._RemoveRAFCallback(this._tickCallback),
this._hasTickCallback=!1)}Tick(){}};
window.RateLimiter=class{constructor(b,a){this._callback=b;this._interval=a;this._timerId=-1;this._lastCallTime=-Infinity;this._timerCallFunc=()=>this._OnTimer();this._canRunImmediate=this._ignoreReset=!1}SetCanRunImmediate(b){this._canRunImmediate=!!b}Call(){if(-1===this._timerId){var b=Date.now(),a=b-this._lastCallTime,c=this._interval;a>=c&&this._canRunImmediate?(this._lastCallTime=b,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(c-a,4))}}_RunCallback(){this._ignoreReset=
!0;this._callback();this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._lastCallTime=Date.now())}_OnTimer(){this._timerId=-1;this._lastCallTime=Date.now();this._RunCallback()}_CancelTimer(){-1!==this._timerId&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer();this._timerCallFunc=this._callback=null}};"use strict";
class ElementState{constructor(b){this._elem=b;this._hadFirstUpdate=!1;this._isVisibleFlag=!0}SetVisibleFlag(b){this._isVisibleFlag=!!b}GetVisibleFlag(){return this._isVisibleFlag}HadFirstUpdate(){return this._hadFirstUpdate}SetHadFirstUpdate(){this._hadFirstUpdate=!0}GetElement(){return this._elem}}
window.DOMElementHandler=class extends self.DOMHandler{constructor(b,a){super(b,a);this._elementMap=new Map;this._autoAttach=!0;this.AddRuntimeMessageHandlers([["create",c=>this._OnCreate(c)],["destroy",c=>this._OnDestroy(c)],["set-visible",c=>this._OnSetVisible(c)],["update-position",c=>this._OnUpdatePosition(c)],["update-state",c=>this._OnUpdateState(c)],["focus",c=>this._OnSetFocus(c)],["set-css-style",c=>this._OnSetCssStyle(c)],["set-attribute",c=>this._OnSetAttribute(c)],["remove-attribute",
c=>this._OnRemoveAttribute(c)]]);this.AddDOMElementMessageHandler("get-element",c=>c)}SetAutoAttach(b){this._autoAttach=!!b}AddDOMElementMessageHandler(b,a){this.AddRuntimeMessageHandler(b,c=>{const d=this.GetElementById(c.elementId);return a(d,c)})}_OnCreate(b){const a=b.elementId,c=this.CreateElement(a,b),d=new ElementState(c);this._elementMap.set(a,d);c.style.boxSizing="border-box";c.style.display="none";d.SetVisibleFlag(b.isVisible);b=this._GetFocusElement(c);b.addEventListener("focus",e=>this._OnFocus(a));
b.addEventListener("blur",e=>this._OnBlur(a));this._autoAttach&&document.body.appendChild(c)}CreateElement(b,a){throw Error("required override");}DestroyElement(b){}_OnDestroy(b){b=b.elementId;const a=this.GetElementById(b);this.DestroyElement(a);this._autoAttach&&a.parentElement.removeChild(a);this._elementMap.delete(b)}PostToRuntimeElement(b,a,c){c||(c={});c.elementId=a;this.PostToRuntime(b,c)}_PostToRuntimeElementMaybeSync(b,a,c){c||(c={});c.elementId=a;this._PostToRuntimeMaybeSync(b,c)}_OnSetVisible(b){if(this._autoAttach){var a=
this._elementMap.get(b.elementId),c=a.GetElement();a.HadFirstUpdate()?c.style.display=b.isVisible?"":"none":a.SetVisibleFlag(b.isVisible)}}_OnUpdatePosition(b){if(this._autoAttach){var a=this._elementMap.get(b.elementId),c=a.GetElement();c.style.left=b.left+"px";c.style.top=b.top+"px";c.style.width=b.width+"px";c.style.height=b.height+"px";b=b.fontSize;null!==b&&(c.style.fontSize=b+"em");a.HadFirstUpdate()||(a.SetHadFirstUpdate(),a.GetVisibleFlag()&&(c.style.display=""))}}_OnUpdateState(b){const a=
this.GetElementById(b.elementId);this.UpdateState(a,b)}UpdateState(b,a){throw Error("required override");}_GetFocusElement(b){return b}_OnFocus(b){this.PostToRuntimeElement("elem-focused",b)}_OnBlur(b){this.PostToRuntimeElement("elem-blurred",b)}_OnSetFocus(b){const a=this._GetFocusElement(this.GetElementById(b.elementId));b.focus?a.focus():a.blur()}_OnSetCssStyle(b){const a=this.GetElementById(b.elementId),c=b.prop;b=b.val;c.startsWith("--")?a.style.setProperty(c,b):a.style[c]=b}_OnSetAttribute(b){this.GetElementById(b.elementId).setAttribute(b.name,
b.val)}_OnRemoveAttribute(b){this.GetElementById(b.elementId).removeAttribute(b.name)}GetElementById(b){const a=this._elementMap.get(b);if(!a)throw Error(`no element with id ${b}`);return a.GetElement()}};"use strict";const isiOSLike=/(iphone|ipod|ipad|macos|macintosh|mac os x)/i.test(navigator.userAgent),isAndroid=/android/i.test(navigator.userAgent),isSafari=/safari/i.test(navigator.userAgent)&&!/(chrome|chromium|edg\/|OPR\/|nwjs)/i.test(navigator.userAgent);let resolveCounter=0;
function AddScript(b){const a=document.createElement("script");a.async=!1;a.type="module";return b.isStringSrc?new Promise(c=>{const d="c3_resolve_"+resolveCounter;++resolveCounter;self[d]=c;a.textContent=b.str+`\n\nself["${d}"]();`;document.head.appendChild(a)}):new Promise((c,d)=>{a.onload=c;a.onerror=d;a.src=b;document.head.appendChild(a)})}let didCheckWorkerModuleSupport=!1,isWorkerModuleSupported=!1;
function SupportsWorkerTypeModule(){if(!didCheckWorkerModuleSupport){try{new Worker("blob://",{get type(){isWorkerModuleSupported=!0}})}catch(b){}didCheckWorkerModuleSupport=!0}return isWorkerModuleSupported}let tmpAudio=new Audio;
const supportedAudioFormats={"audio/webm; codecs=opus":!!tmpAudio.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!tmpAudio.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!tmpAudio.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!tmpAudio.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!tmpAudio.canPlayType("audio/mp4"),"audio/mpeg":!!tmpAudio.canPlayType("audio/mpeg")};tmpAudio=null;
async function BlobToString(b){b=await BlobToArrayBuffer(b);return(new TextDecoder("utf-8")).decode(b)}function BlobToArrayBuffer(b){return new Promise((a,c)=>{const d=new FileReader;d.onload=e=>a(e.target.result);d.onerror=e=>c(e);d.readAsArrayBuffer(b)})}const queuedArrayBufferReads=[];let activeArrayBufferReads=0;window.RealFile=window.File;const domHandlerClasses=[],runtimeEventHandlers=new Map,pendingResponsePromises=new Map;let nextResponseId=0;const runOnStartupFunctions=[];
self.runOnStartup=function(b){if("function"!==typeof b)throw Error("runOnStartup called without a function");runOnStartupFunctions.push(b)};const WEBVIEW_EXPORT_TYPES=new Set(["cordova","playable-ad","instant-games"]);function IsWebViewExportType(b){return WEBVIEW_EXPORT_TYPES.has(b)}let isWrapperFullscreen=!1;
window.RuntimeInterface=class b{constructor(a){this._useWorker=a.useWorker;this._messageChannelPort=null;this._runtimeBaseUrl="";this._scriptFolder=a.scriptFolder;this._workerScriptURLs={};this._localRuntime=this._worker=null;this._domHandlers=[];this._canvas=this._runtimeDomHandler=null;this._isExportingToVideo=!1;this._exportToVideoDuration=0;this._jobScheduler=null;this._rafId=-1;this._rafFunc=()=>this._OnRAFCallback();this._rafCallbacks=[];this._exportType=a.exportType;this._isFileProtocol="file"===
location.protocol.substr(0,4);!this._useWorker||"undefined"!==typeof OffscreenCanvas&&navigator.userActivation&&SupportsWorkerTypeModule()||(this._useWorker=!1);this._useWorker&&isSafari&&(this._useWorker=!1);if("playable-ad"===this._exportType||"instant-games"===this._exportType)this._useWorker=!1;if("cordova"===this._exportType&&this._useWorker)if(isAndroid){const c=/Chrome\/(\d+)/i.exec(navigator.userAgent);c&&90<=parseInt(c[1],10)||(this._useWorker=!1)}else this._useWorker=!1;this._localFileStrings=
this._localFileBlobs=null;"html5"!==this._exportType||window.isSecureContext||console.warn("[Construct] Warning: the browser indicates this is not a secure context. Some features may be unavailable. Use secure (HTTPS) hosting to ensure all features are available.");this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",c=>this._OnCordovaFetchLocalFile(c));this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",c=>this._OnCreateJobWorker(c));"cordova"===this._exportType?
document.addEventListener("deviceready",()=>this._Init(a)):this._Init(a)}Release(){this._CancelAnimationFrame();this._messageChannelPort&&(this._messageChannelPort=this._messageChannelPort.onmessage=null);this._worker&&(this._worker.terminate(),this._worker=null);this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null);this._canvas&&(this._canvas.parentElement.removeChild(this._canvas),this._canvas=null)}GetCanvas(){return this._canvas}GetRuntimeBaseURL(){return this._runtimeBaseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsFileProtocol(){return this._isFileProtocol}GetScriptFolder(){return this._scriptFolder}IsiOSCordova(){return isiOSLike&&
"cordova"===this._exportType}IsiOSWebView(){const a=navigator.userAgent;return isiOSLike&&IsWebViewExportType(this._exportType)||navigator.standalone||/crios\/|fxios\/|edgios\//i.test(a)}IsAndroid(){return isAndroid}IsAndroidWebView(){return isAndroid&&IsWebViewExportType(this._exportType)}async _Init(a){"macos-wkwebview"===this._exportType&&this._SendWrapperMessage({type:"ready"});if("playable-ad"===this._exportType){this._localFileBlobs=self.c3_base64files;this._localFileStrings={};await this._ConvertDataUrisToBlobs();
for(let d=0,e=a.engineScripts.length;d<e;++d){var c=a.engineScripts[d];this._localFileStrings.hasOwnProperty(c)?a.engineScripts[d]={isStringSrc:!0,str:this._localFileStrings[c]}:this._localFileBlobs.hasOwnProperty(c)&&(a.engineScripts[d]=URL.createObjectURL(this._localFileBlobs[c]))}a.workerDependencyScripts=[]}if("nwjs"===this._exportType&&self.nw&&self.nw.App.manifest["c3-steam-mode"]){let d=0;this._AddRAFCallback(()=>{d++;document.body.style.opacity=0===d%2?"1":"0.999"})}a.runtimeBaseUrl?this._runtimeBaseUrl=
a.runtimeBaseUrl:(c=location.origin,this._runtimeBaseUrl=("null"===c?"file:///":c)+location.pathname,c=this._runtimeBaseUrl.lastIndexOf("/"),-1!==c&&(this._runtimeBaseUrl=this._runtimeBaseUrl.substr(0,c+1)));a.workerScripts&&(this._workerScriptURLs=a.workerScripts);c=new MessageChannel;this._messageChannelPort=c.port1;this._messageChannelPort.onmessage=d=>this._OnMessageFromRuntime(d.data);window.c3_addPortMessageHandler&&window.c3_addPortMessageHandler(d=>this._OnMessageFromDebugger(d));this._jobScheduler=
new self.JobSchedulerDOM(this);await this._jobScheduler.Init();"object"===typeof window.StatusBar&&window.StatusBar.hide();if("object"===typeof window.AndroidFullScreen)try{await new Promise((d,e)=>{window.AndroidFullScreen.immersiveMode(d,e)})}catch(d){console.error("Failed to enter Android immersive mode: ",d)}this._useWorker?await this._InitWorker(a,c.port2):await this._InitDOM(a,c.port2)}_GetWorkerURL(a){a=this._workerScriptURLs.hasOwnProperty(a)?this._workerScriptURLs[a]:a.endsWith("/workermain.js")&&
this._workerScriptURLs.hasOwnProperty("workermain.js")?this._workerScriptURLs["workermain.js"]:"playable-ad"===this._exportType&&this._localFileBlobs.hasOwnProperty(a)?this._localFileBlobs[a]:a;a instanceof Blob&&(a=URL.createObjectURL(a));return a}async CreateWorker(a,c,d){if(a.startsWith("blob:"))return new Worker(a,d);if("cordova"===this._exportType&&this._isFileProtocol)return a=await this.CordovaFetchLocalFileAsArrayBuffer(d.isC3MainWorker?a:this._scriptFolder+a),a=new Blob([a],{type:"application/javascript"}),
new Worker(URL.createObjectURL(a),d);a=new URL(a,c);if(location.origin!==a.origin){a=await fetch(a);if(!a.ok)throw Error("failed to fetch worker script");a=await a.blob();return new Worker(URL.createObjectURL(a),d)}return new Worker(a,d)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}_GetCommonRuntimeOptions(a){return{runtimeBaseUrl:this._runtimeBaseUrl,previewUrl:location.href,windowInnerWidth:this._GetWindowInnerWidth(),
windowInnerHeight:this._GetWindowInnerHeight(),devicePixelRatio:window.devicePixelRatio,isFullscreen:b.IsDocumentFullscreen(),projectData:a.projectData,previewImageBlobs:window.cr_previewImageBlobs||this._localFileBlobs,previewProjectFileBlobs:window.cr_previewProjectFileBlobs,previewProjectFileSWUrls:window.cr_previewProjectFiles,swClientId:window.cr_swClientId||"",exportType:a.exportType,isDebug:(new URLSearchParams(self.location.search)).has("debug"),ife:!!self.ife,jobScheduler:this._jobScheduler.GetPortData(),
supportedAudioFormats,opusWasmScriptUrl:window.cr_opusWasmScriptUrl||this._scriptFolder+"opus.wasm.js",opusWasmBinaryUrl:window.cr_opusWasmBinaryUrl||this._scriptFolder+"opus.wasm.wasm",isFileProtocol:this._isFileProtocol,isiOSCordova:this.IsiOSCordova(),isiOSWebView:this.IsiOSWebView(),isFBInstantAvailable:"undefined"!==typeof self.FBInstant}}async _InitWorker(a,c){const d=this._GetWorkerURL(a.workerMainUrl);"preview"===this._exportType?(this._worker=new Worker("previewworker.js",{type:"module",
name:"Runtime"}),await new Promise((h,k)=>{const m=l=>{this._worker.removeEventListener("message",m);l.data&&"ok"===l.data.type?h():k()};this._worker.addEventListener("message",m);this._worker.postMessage({type:"construct-worker-init","import":(new URL(d,this._runtimeBaseUrl)).toString()})})):this._worker=await this.CreateWorker(d,this._runtimeBaseUrl,{type:"module",name:"Runtime",isC3MainWorker:!0});this._canvas=document.createElement("canvas");this._canvas.style.display="none";const e=this._canvas.transferControlToOffscreen();
document.body.appendChild(this._canvas);window.c3canvas=this._canvas;self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders();let f=a.workerDependencyScripts||[],g=a.engineScripts;f=await Promise.all(f.map(h=>this._MaybeGetCordovaScriptURL(h)));g=await Promise.all(g.map(h=>this._MaybeGetCordovaScriptURL(h)));if("cordova"===this._exportType)for(let h=0,k=a.projectScripts.length;h<k;++h){const m=a.projectScripts[h],l=m[0];if(l===a.mainProjectScript||"scriptsInEvents.js"===l||l.endsWith("/scriptsInEvents.js"))m[1]=
await this._MaybeGetCordovaScriptURL(l)}this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(a),{type:"init-runtime",isInWorker:!0,messagePort:c,canvas:e,workerDependencyScripts:f,engineScripts:g,projectScripts:a.projectScripts,mainProjectScript:a.mainProjectScript,projectScriptsStatus:self.C3_ProjectScriptsStatus}),[c,e,...this._jobScheduler.GetPortTransferables()]);this._domHandlers=domHandlerClasses.map(h=>new h(this));this._FindRuntimeDOMHandler();this._runtimeDomHandler._EnableWindowResizeEvent();
self.c3_callFunction=(h,k)=>this._runtimeDomHandler._InvokeFunctionFromJS(h,k);"preview"===this._exportType&&(self.goToLastErrorScript=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(a,c){this._canvas=document.createElement("canvas");this._canvas.style.display="none";document.body.appendChild(this._canvas);window.c3canvas=this._canvas;self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders();this._domHandlers=domHandlerClasses.map(g=>new g(this));this._FindRuntimeDOMHandler();
var d=a.engineScripts.map(g=>"string"===typeof g?(new URL(g,this._runtimeBaseUrl)).toString():g);Array.isArray(a.workerDependencyScripts)&&d.unshift(...a.workerDependencyScripts);d=await Promise.all(d.map(g=>this._MaybeGetCordovaScriptURL(g)));await Promise.all(d.map(g=>AddScript(g)));d=self.C3_ProjectScriptsStatus;const e=a.mainProjectScript,f=a.projectScripts;for(let [g,h]of f)if(h||(h=g),g===e)try{h=await this._MaybeGetCordovaScriptURL(h),await AddScript(h),"preview"!==this._exportType||d[g]||
this._ReportProjectMainScriptError(g,"main script did not run to completion")}catch(k){this._ReportProjectMainScriptError(g,k)}else if("scriptsInEvents.js"===g||g.endsWith("/scriptsInEvents.js"))h=await this._MaybeGetCordovaScriptURL(h),await AddScript(h);"preview"===this._exportType&&"object"!==typeof self.C3.ScriptsInEvents?(this._RemoveLoadingMessage(),console.error("[C3 runtime] Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax."),alert("Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax.")):
(a=Object.assign(this._GetCommonRuntimeOptions(a),{isInWorker:!1,messagePort:c,canvas:this._canvas,runOnStartupFunctions}),this._runtimeDomHandler._EnableWindowResizeEvent(),this._OnBeforeCreateRuntime(),this._localRuntime=self.C3_CreateRuntime(a),await self.C3_InitRuntime(this._localRuntime,a))}_ReportProjectMainScriptError(a,c){this._RemoveLoadingMessage();console.error(`[Preview] Failed to load project main script (${a}): `,c);alert(`Failed to load project main script (${a}). Check all your JavaScript code has valid syntax. Press F12 and check the console for error details.`)}_OnBeforeCreateRuntime(){this._RemoveLoadingMessage()}_RemoveLoadingMessage(){const a=
window.cr_previewLoadingElem;a&&(a.parentElement.removeChild(a),window.cr_previewLoadingElem=null)}async _OnCreateJobWorker(a){a=await this._jobScheduler._CreateJobWorker();return{outputPort:a,transferables:[a]}}_GetLocalRuntime(){if(this._useWorker)throw Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(a,c,d,e,f){this._messageChannelPort.postMessage({type:"event",component:a,handler:c,dispatchOpts:e||null,data:d,responseId:null},f)}PostToRuntimeComponentAsync(a,
c,d,e,f){const g=nextResponseId++,h=new Promise((k,m)=>{pendingResponsePromises.set(g,{resolve:k,reject:m})});this._messageChannelPort.postMessage({type:"event",component:a,handler:c,dispatchOpts:e||null,data:d,responseId:g},f);return h}_OnMessageFromRuntime(a){const c=a.type;if("event"===c)return this._OnEventFromRuntime(a);if("result"===c)this._OnResultFromRuntime(a);else if("runtime-ready"===c)this._OnRuntimeReady();else if("alert-error"===c)this._RemoveLoadingMessage(),alert(a.message);else if("creating-runtime"===
c)this._OnBeforeCreateRuntime();else throw Error(`unknown message '${c}'`);}_OnEventFromRuntime(a){const c=a.component,d=a.handler,e=a.data,f=a.responseId;if(a=runtimeEventHandlers.get(c))if(a=a.get(d)){var g=null;try{g=a(e)}catch(h){console.error(`Exception in '${c}' handler '${d}':`,h);null!==f&&this._PostResultToRuntime(f,!1,""+h);return}if(null===f)return g;g&&g.then?g.then(h=>this._PostResultToRuntime(f,!0,h)).catch(h=>{console.error(`Rejection from '${c}' handler '${d}':`,h);this._PostResultToRuntime(f,
!1,""+h)}):this._PostResultToRuntime(f,!0,g)}else console.warn(`[DOM] No handler '${d}' for component '${c}'`);else console.warn(`[DOM] No event handlers for component '${c}'`)}_PostResultToRuntime(a,c,d){let e;d&&d.transferables&&(e=d.transferables);this._messageChannelPort.postMessage({type:"result",responseId:a,isOk:c,result:d},e)}_OnResultFromRuntime(a){const c=a.responseId,d=a.isOk;a=a.result;const e=pendingResponsePromises.get(c);d?e.resolve(a):e.reject(a);pendingResponsePromises.delete(c)}AddRuntimeComponentMessageHandler(a,
c,d){let e=runtimeEventHandlers.get(a);e||(e=new Map,runtimeEventHandlers.set(a,e));if(e.has(c))throw Error(`[DOM] Component '${a}' already has handler '${c}'`);e.set(c,d)}static AddDOMHandlerClass(a){if(domHandlerClasses.includes(a))throw Error("DOM handler already added");domHandlerClasses.push(a)}_FindRuntimeDOMHandler(){for(const a of this._domHandlers)if("runtime"===a.GetComponentID()){this._runtimeDomHandler=a;return}throw Error("cannot find runtime DOM handler");}_OnMessageFromDebugger(a){this.PostToRuntimeComponent("debugger",
"message",a)}_OnRuntimeReady(){for(const a of this._domHandlers)a.Attach()}static IsDocumentFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||isWrapperFullscreen)}static _SetWrapperIsFullscreenFlag(a){isWrapperFullscreen=!!a}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(a){this._rafCallbacks.push(a);this._RequestAnimationFrame()}_RemoveRAFCallback(a){a=
this._rafCallbacks.indexOf(a);if(-1===a)throw Error("invalid callback");this._rafCallbacks.splice(a,1);this._rafCallbacks.length||this._CancelAnimationFrame()}_RequestAnimationFrame(){-1===this._rafId&&this._rafCallbacks.length&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const a of this._rafCallbacks)a();this._RequestAnimationFrame()}TryPlayMedia(a){this._runtimeDomHandler.TryPlayMedia(a)}RemovePendingPlay(a){this._runtimeDomHandler.RemovePendingPlay(a)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(a){this._runtimeDomHandler.SetSilent(a)}IsAudioFormatSupported(a){return!!supportedAudioFormats[a]}async _WasmDecodeWebMOpus(a){a=
await this.PostToRuntimeComponentAsync("runtime","opus-decode",{arrayBuffer:a},null,[a]);return new Float32Array(a)}SetIsExportingToVideo(a){this._isExportingToVideo=!0;this._exportToVideoDuration=a}IsExportingToVideo(){return this._isExportingToVideo}GetExportToVideoDuration(){return this._exportToVideoDuration}IsAbsoluteURL(a){return/^(?:[a-z\-]+:)?\/\//.test(a)||"data:"===a.substr(0,5)||"blob:"===a.substr(0,5)}IsRelativeURL(a){return!this.IsAbsoluteURL(a)}async _MaybeGetCordovaScriptURL(a){return"cordova"===
this._exportType&&(a.startsWith("file:")||this._isFileProtocol&&this.IsRelativeURL(a))?(a.startsWith(this._runtimeBaseUrl)&&(a=a.substr(this._runtimeBaseUrl.length)),a=await this.CordovaFetchLocalFileAsArrayBuffer(a),a=new Blob([a],{type:"application/javascript"}),URL.createObjectURL(a)):a}async _OnCordovaFetchLocalFile(a){const c=a.filename;switch(a.as){case "text":return await this.CordovaFetchLocalFileAsText(c);case "buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(c);default:throw Error("unsupported type");
}}_GetPermissionAPI(){const a=window.cordova&&window.cordova.plugins&&window.cordova.plugins.permissions;if("object"!==typeof a)throw Error("Permission API is not loaded");return a}_MapPermissionID(a,c){a=a[c];if("string"!==typeof a)throw Error("Invalid permission name");return a}_HasPermission(a){const c=this._GetPermissionAPI();return new Promise((d,e)=>c.checkPermission(this._MapPermissionID(c,a),f=>d(!!f.hasPermission),e))}_RequestPermission(a){const c=this._GetPermissionAPI();return new Promise((d,
e)=>c.requestPermission(this._MapPermissionID(c,a),f=>d(!!f.hasPermission),e))}async RequestPermissions(a){if("cordova"!==this.GetExportType()||this.IsiOSCordova())return!0;for(const c of a)if(!await this._HasPermission(c)&&!1===await this._RequestPermission(c))return!1;return!0}async RequirePermissions(...a){if(!1===await this.RequestPermissions(a))throw Error("Permission not granted");}CordovaFetchLocalFile(a){const c=window.cordova.file.applicationDirectory+"www/"+a;return new Promise((d,e)=>{window.resolveLocalFileSystemURL(c,
f=>{f.file(d,e)},e)})}async CordovaFetchLocalFileAsText(a){a=await this.CordovaFetchLocalFile(a);return await BlobToString(a)}_CordovaMaybeStartNextArrayBufferRead(){if(queuedArrayBufferReads.length&&!(8<=activeArrayBufferReads)){activeArrayBufferReads++;var a=queuedArrayBufferReads.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(a.filename,a.successCallback,a.errorCallback)}}CordovaFetchLocalFileAsArrayBuffer(a){return new Promise((c,d)=>{queuedArrayBufferReads.push({filename:a,successCallback:e=>
{activeArrayBufferReads--;this._CordovaMaybeStartNextArrayBufferRead();c(e)},errorCallback:e=>{activeArrayBufferReads--;this._CordovaMaybeStartNextArrayBufferRead();d(e)}});this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(a,c,d){try{const e=await this.CordovaFetchLocalFile(a),f=await BlobToArrayBuffer(e);c(f)}catch(e){d(e)}}_SendWrapperMessage(a){if("windows-webview2"===this._exportType)window.chrome.webview.postMessage(JSON.stringify(a));else if("macos-wkwebview"===
this._exportType)window.webkit.messageHandlers.C3Wrapper.postMessage(JSON.stringify(a));else throw Error("cannot send wrapper message");}async _ConvertDataUrisToBlobs(){const a=[];for(const [c,d]of Object.entries(this._localFileBlobs))a.push(this._ConvertDataUriToBlobs(c,d));await Promise.all(a)}async _ConvertDataUriToBlobs(a,c){if("object"===typeof c)this._localFileBlobs[a]=new Blob([c.str],{type:c.type}),this._localFileStrings[a]=c.str;else{let d=await this._FetchDataUri(c);d||(d=this._DataURIToBinaryBlobSync(c));
this._localFileBlobs[a]=d}}async _FetchDataUri(a){try{return await (await fetch(a)).blob()}catch(c){return console.warn("Failed to fetch a data: URI. Falling back to a slower workaround. This is probably because the Content Security Policy unnecessarily blocked it. Allow data: URIs in your CSP to avoid this.",c),null}}_DataURIToBinaryBlobSync(a){a=this._ParseDataURI(a);return this._BinaryStringToBlob(a.data,a.mime_type)}_ParseDataURI(a){var c=a.indexOf(",");if(0>c)throw new URIError("expected comma in data: uri");
var d=a.substring(5,c);a=a.substring(c+1);c=d.split(";");d=c[0]||"";const e=c[2];a="base64"===c[1]||"base64"===e?atob(a):decodeURIComponent(a);return{mime_type:d,data:a}}_BinaryStringToBlob(a,c){var d=a.length;let e=d>>2,f=new Uint8Array(d),g=new Uint32Array(f.buffer,0,e),h,k;for(k=h=0;h<e;++h)g[h]=a.charCodeAt(k++)|a.charCodeAt(k++)<<8|a.charCodeAt(k++)<<16|a.charCodeAt(k++)<<24;for(d&=3;d--;)f[k]=a.charCodeAt(k),++k;return new Blob([f],{type:c})}};"use strict";const RuntimeInterface$jscomp$1=self.RuntimeInterface;
function IsCompatibilityMouseEvent(b){return b.sourceCapabilities&&b.sourceCapabilities.firesTouchEvents||b.originalEvent&&b.originalEvent.sourceCapabilities&&b.originalEvent.sourceCapabilities.firesTouchEvents}const KEY_CODE_ALIASES=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),DISPATCH_RUNTIME_AND_SCRIPT={dispatchRuntimeEvent:!0,dispatchUserScriptEvent:!0},DISPATCH_SCRIPT_ONLY={dispatchUserScriptEvent:!0},DISPATCH_RUNTIME_ONLY={dispatchRuntimeEvent:!0};
function AddStyleSheet(b){return new Promise((a,c)=>{const d=document.createElement("link");d.onload=()=>a(d);d.onerror=e=>c(e);d.rel="stylesheet";d.href=b;document.head.appendChild(d)})}function FetchImage(b){return new Promise((a,c)=>{const d=new Image;d.onload=()=>a(d);d.onerror=e=>c(e);d.src=b})}async function BlobToImage(b){b=URL.createObjectURL(b);try{return await FetchImage(b)}finally{URL.revokeObjectURL(b)}}
function BlobToString$jscomp$1(b){return new Promise((a,c)=>{let d=new FileReader;d.onload=e=>a(e.target.result);d.onerror=e=>c(e);d.readAsText(b)})}
async function BlobToSvgImage(b,a,c){if(!/firefox/i.test(navigator.userAgent))return await BlobToImage(b);var d=await BlobToString$jscomp$1(b);d=(new DOMParser).parseFromString(d,"image/svg+xml");const e=d.documentElement;if(e.hasAttribute("width")&&e.hasAttribute("height")){const f=e.getAttribute("width"),g=e.getAttribute("height");if(!f.includes("%")&&!g.includes("%"))return await BlobToImage(b)}e.setAttribute("width",a+"px");e.setAttribute("height",c+"px");d=(new XMLSerializer).serializeToString(d);
b=new Blob([d],{type:"image/svg+xml"});return await BlobToImage(b)}function IsInContentEditable(b){do{if(b.parentNode&&b.hasAttribute("contenteditable"))return!0;b=b.parentNode}while(b);return!1}const keyboardInputElementTagNames=new Set(["input","textarea","datalist","select"]);function IsKeyboardInputElement(b){return keyboardInputElementTagNames.has(b.tagName.toLowerCase())||IsInContentEditable(b)}const canvasOrDocTags=new Set(["canvas","body","html"]);
function PreventDefaultOnCanvasOrDoc(b){if(b.target.tagName){var a=b.target.tagName.toLowerCase();canvasOrDocTags.has(a)&&b.preventDefault()}}function BlockWheelZoom(b){(b.metaKey||b.ctrlKey)&&b.preventDefault()}
self.C3_GetSvgImageSize=async function(b){b=await BlobToImage(b);if(0<b.width&&0<b.height)return[b.width,b.height];b.style.position="absolute";b.style.left="0px";b.style.top="0px";b.style.visibility="hidden";document.body.appendChild(b);const a=b.getBoundingClientRect();document.body.removeChild(b);return[a.width,a.height]};
self.C3_RasterSvgImageBlob=async function(b,a,c,d,e){b=await BlobToSvgImage(b,a,c);const f=document.createElement("canvas");f.width=d;f.height=e;f.getContext("2d").drawImage(b,0,0,a,c);return f};let isCordovaPaused=!1;document.addEventListener("pause",()=>isCordovaPaused=!0);document.addEventListener("resume",()=>isCordovaPaused=!1);function ParentHasFocus(){try{return window.parent&&window.parent.document.hasFocus()}catch(b){return!1}}
function KeyboardIsVisible(){const b=document.activeElement;if(!b)return!1;const a=b.tagName.toLowerCase(),c=new Set("email number password search tel text url".split(" "));return"textarea"===a?!0:"input"===a?c.has(b.type.toLowerCase()||"text"):IsInContentEditable(b)}
RuntimeInterface$jscomp$1.AddDOMHandlerClass(class extends self.DOMHandler{constructor(b){super(b,"runtime");this._isFirstSizeUpdate=!0;this._enableWindowResizeEvent=!1;this._simulatedResizeTimerId=-1;this._targetOrientation="any";this._attachedDeviceMotionEvent=this._attachedDeviceOrientationEvent=!1;this._screenReaderTextWrap=document.createElement("div");this._screenReaderTextWrap.className="c3-screen-reader-text";this._screenReaderTextWrap.setAttribute("aria-live","polite");document.body.appendChild(this._screenReaderTextWrap);
this._debugHighlightElem=null;this._isExportToVideo=!1;this._exportVideoProgressMessage="";this._exportVideoUpdateTimerId=-1;this._enableAndroidVKDetection=!1;this._lastWindowWidth=b._GetWindowInnerWidth();this._lastWindowHeight=b._GetWindowInnerHeight();this._vkTranslateYOffset=this._virtualKeyboardHeight=0;b.AddRuntimeComponentMessageHandler("canvas","update-size",d=>this._OnUpdateCanvasSize(d));b.AddRuntimeComponentMessageHandler("runtime","invoke-download",d=>this._OnInvokeDownload(d));b.AddRuntimeComponentMessageHandler("runtime",
"load-webfonts",d=>this._OnLoadWebFonts(d));b.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",d=>this._OnRasterSvgImage(d));b.AddRuntimeComponentMessageHandler("runtime","get-svg-image-size",d=>this._OnGetSvgImageSize(d));b.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",d=>this._OnSetTargetOrientation(d));b.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW());b.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",d=>this._OnPostToDebugger(d));
b.AddRuntimeComponentMessageHandler("runtime","go-to-script",d=>this._OnPostToDebugger(d));b.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking());b.AddRuntimeComponentMessageHandler("runtime","debug-highlight",d=>this._OnDebugHighlight(d));b.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent());b.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent());
b.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",d=>this._OnAddStylesheet(d));b.AddRuntimeComponentMessageHandler("runtime","script-create-worker",d=>this._OnScriptCreateWorker(d));b.AddRuntimeComponentMessageHandler("runtime","alert",d=>this._OnAlert(d));b.AddRuntimeComponentMessageHandler("runtime","screen-reader-text",d=>this._OnScreenReaderTextEvent(d));b.AddRuntimeComponentMessageHandler("runtime","hide-cordova-splash",()=>this._OnHideCordovaSplash());b.AddRuntimeComponentMessageHandler("runtime",
"set-exporting-to-video",d=>this._SetExportingToVideo(d));b.AddRuntimeComponentMessageHandler("runtime","export-to-video-progress",d=>this._OnExportVideoProgress(d));b.AddRuntimeComponentMessageHandler("runtime","exported-to-video",d=>this._OnExportedToVideo(d));b.AddRuntimeComponentMessageHandler("runtime","exported-to-image-sequence",d=>this._OnExportedToImageSequence(d));const a=new Set(["input","textarea","datalist"]);window.addEventListener("contextmenu",d=>{const e=d.target,f=e.tagName.toLowerCase();
a.has(f)||IsInContentEditable(e)||d.preventDefault()});const c=b.GetCanvas();window.addEventListener("selectstart",PreventDefaultOnCanvasOrDoc);window.addEventListener("gesturehold",PreventDefaultOnCanvasOrDoc);c.addEventListener("selectstart",PreventDefaultOnCanvasOrDoc);c.addEventListener("gesturehold",PreventDefaultOnCanvasOrDoc);window.addEventListener("touchstart",PreventDefaultOnCanvasOrDoc,{passive:!1});"undefined"!==typeof PointerEvent?(window.addEventListener("pointerdown",PreventDefaultOnCanvasOrDoc,
{passive:!1}),c.addEventListener("pointerdown",PreventDefaultOnCanvasOrDoc)):c.addEventListener("touchstart",PreventDefaultOnCanvasOrDoc);this._mousePointerLastButtons=0;window.addEventListener("mousedown",d=>{1===d.button&&d.preventDefault()});window.addEventListener("mousewheel",BlockWheelZoom,{passive:!1});window.addEventListener("wheel",BlockWheelZoom,{passive:!1});window.addEventListener("resize",()=>this._OnWindowResize());window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange());
window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange());window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange());window.addEventListener("fullscreenerror",d=>this._OnFullscreenError(d));window.addEventListener("webkitfullscreenerror",d=>this._OnFullscreenError(d));window.addEventListener("mozfullscreenerror",d=>this._OnFullscreenError(d));if(b.IsiOSWebView())if(window.visualViewport){let d=Infinity;window.visualViewport.addEventListener("resize",()=>{const e=
window.visualViewport.height;e>d&&(document.scrollingElement.scrollTop=0);d=e})}else window.addEventListener("focusout",()=>{KeyboardIsVisible()||(document.scrollingElement.scrollTop=0)});self.C3WrapperOnMessage=d=>this._OnWrapperMessage(d);this._mediaPendingPlay=new Set;this._mediaRemovedPendingPlay=new WeakSet;this._isSilent=!1}_OnBeforeStartTicking(){self.setTimeout(()=>{this._enableAndroidVKDetection=!0},1E3);"cordova"===this._iRuntime.GetExportType()?(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),
document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):document.addEventListener("visibilitychange",()=>this._OnVisibilityChange(document.hidden));return{isSuspended:!(!document.hidden&&!isCordovaPaused)}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus"));window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{parentHasFocus:ParentHasFocus()});this._mousePointerLastButtons=0});window.addEventListener("focusin",a=>{IsKeyboardInputElement(a.target)&&
this._PostRuntimeEvent("keyboard-blur")});window.addEventListener("keydown",a=>this._OnKeyEvent("keydown",a));window.addEventListener("keyup",a=>this._OnKeyEvent("keyup",a));window.addEventListener("dblclick",a=>this._OnMouseEvent("dblclick",a,DISPATCH_RUNTIME_AND_SCRIPT));window.addEventListener("wheel",a=>this._OnMouseWheelEvent("wheel",a));"undefined"!==typeof PointerEvent?(window.addEventListener("pointerdown",a=>{this._HandlePointerDownFocus(a);this._OnPointerEvent("pointerdown",a)}),this._iRuntime.UsesWorker()&&
"undefined"!==typeof window.onpointerrawupdate&&self===self.top?window.addEventListener("pointerrawupdate",a=>this._OnPointerRawUpdate(a)):window.addEventListener("pointermove",a=>this._OnPointerEvent("pointermove",a)),window.addEventListener("pointerup",a=>this._OnPointerEvent("pointerup",a)),window.addEventListener("pointercancel",a=>this._OnPointerEvent("pointercancel",a))):(window.addEventListener("mousedown",a=>{this._HandlePointerDownFocus(a);this._OnMouseEventAsPointer("pointerdown",a)}),window.addEventListener("mousemove",
a=>this._OnMouseEventAsPointer("pointermove",a)),window.addEventListener("mouseup",a=>this._OnMouseEventAsPointer("pointerup",a)),window.addEventListener("touchstart",a=>{this._HandlePointerDownFocus(a);this._OnTouchEvent("pointerdown",a)}),window.addEventListener("touchmove",a=>this._OnTouchEvent("pointermove",a)),window.addEventListener("touchend",a=>this._OnTouchEvent("pointerup",a)),window.addEventListener("touchcancel",a=>this._OnTouchEvent("pointercancel",a)));const b=()=>this._PlayPendingMedia();
window.addEventListener("pointerup",b,!0);window.addEventListener("touchend",b,!0);window.addEventListener("click",b,!0);window.addEventListener("keydown",b,!0);window.addEventListener("gamepadconnected",b,!0);this._iRuntime.IsAndroid()&&!this._iRuntime.IsAndroidWebView()&&navigator.virtualKeyboard&&(navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.addEventListener("geometrychange",()=>{this._OnAndroidVirtualKeyboardChange(this._GetWindowInnerHeight(),navigator.virtualKeyboard.boundingRect.height)}))}_OnAndroidVirtualKeyboardChange(b,
a){document.body.style.transform="";this._vkTranslateYOffset=0;if(0<a){var c=document.activeElement;c&&(c=c.getBoundingClientRect(),b=(c.top+c.bottom)/2-(b-a)/2,b>a&&(b=a),0>b&&(b=0),0<b&&(document.body.style.transform=`translateY(${-b}px)`,this._vkTranslateYOffset=b))}}_PostRuntimeEvent(b,a){this.PostToRuntime(b,a||null,DISPATCH_RUNTIME_ONLY)}_GetWindowInnerWidth(){return this._iRuntime._GetWindowInnerWidth()}_GetWindowInnerHeight(){return this._iRuntime._GetWindowInnerHeight()}_EnableWindowResizeEvent(){this._enableWindowResizeEvent=
!0;this._lastWindowWidth=this._iRuntime._GetWindowInnerWidth();this._lastWindowHeight=this._iRuntime._GetWindowInnerHeight()}_OnWindowResize(){if(!this._isExportToVideo&&this._enableWindowResizeEvent){var b=this._GetWindowInnerWidth(),a=this._GetWindowInnerHeight();if(this._iRuntime.IsAndroidWebView()){if(this._enableAndroidVKDetection){if(this._lastWindowWidth===b&&a<this._lastWindowHeight){this._virtualKeyboardHeight=this._lastWindowHeight-a;this._OnAndroidVirtualKeyboardChange(this._lastWindowHeight,
this._virtualKeyboardHeight);return}0<this._virtualKeyboardHeight&&(this._virtualKeyboardHeight=0,this._OnAndroidVirtualKeyboardChange(a,this._virtualKeyboardHeight))}this._lastWindowWidth=b;this._lastWindowHeight=a}this.PostToRuntime("window-resize",{innerWidth:b,innerHeight:a,devicePixelRatio:window.devicePixelRatio,isFullscreen:RuntimeInterface$jscomp$1.IsDocumentFullscreen()});this._iRuntime.IsiOSWebView()&&(-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(b,
a,0))}}_ScheduleSimulatedResize(b,a,c){-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId);this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(b,a,c),48)}_OnSimulatedResize(b,a,c){const d=this._GetWindowInnerWidth(),e=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1;d!=b||e!=a?this.PostToRuntime("window-resize",{innerWidth:d,innerHeight:e,devicePixelRatio:window.devicePixelRatio,isFullscreen:RuntimeInterface$jscomp$1.IsDocumentFullscreen()}):10>
c&&this._ScheduleSimulatedResize(d,e,c+1)}_OnSetTargetOrientation(b){this._targetOrientation=b.targetOrientation}_TrySetTargetOrientation(){const b=this._targetOrientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(b).catch(a=>console.warn("[Construct] Failed to lock orientation: ",a));else try{let a=!1;screen.lockOrientation?a=screen.lockOrientation(b):screen.webkitLockOrientation?a=screen.webkitLockOrientation(b):screen.mozLockOrientation?a=screen.mozLockOrientation(b):
screen.msLockOrientation&&(a=screen.msLockOrientation(b));a||console.warn("[Construct] Failed to lock orientation")}catch(a){console.warn("[Construct] Failed to lock orientation: ",a)}}_OnFullscreenChange(){if(!this._isExportToVideo){var b=RuntimeInterface$jscomp$1.IsDocumentFullscreen();b&&"any"!==this._targetOrientation&&this._TrySetTargetOrientation();this.PostToRuntime("fullscreenchange",{isFullscreen:b,innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}}_OnFullscreenError(b){console.warn("[Construct] Fullscreen request failed: ",
b);this.PostToRuntime("fullscreenerror",{isFullscreen:RuntimeInterface$jscomp$1.IsDocumentFullscreen(),innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnVisibilityChange(b){b?this._iRuntime._CancelAnimationFrame():this._iRuntime._RequestAnimationFrame();this.PostToRuntime("visibilitychange",{hidden:b})}_OnKeyEvent(b,a){"Backspace"===a.key&&PreventDefaultOnCanvasOrDoc(a);if(!this._isExportToVideo){var c=KEY_CODE_ALIASES.get(a.code)||a.code;this._PostToRuntimeMaybeSync(b,
{code:c,key:a.key,which:a.which,repeat:a.repeat,altKey:a.altKey,ctrlKey:a.ctrlKey,metaKey:a.metaKey,shiftKey:a.shiftKey,timeStamp:a.timeStamp},DISPATCH_RUNTIME_AND_SCRIPT)}}_OnMouseWheelEvent(b,a){this._isExportToVideo||this.PostToRuntime(b,{clientX:a.clientX,clientY:a.clientY+this._vkTranslateYOffset,pageX:a.pageX,pageY:a.pageY+this._vkTranslateYOffset,deltaX:a.deltaX,deltaY:a.deltaY,deltaZ:a.deltaZ,deltaMode:a.deltaMode,timeStamp:a.timeStamp},DISPATCH_RUNTIME_AND_SCRIPT)}_OnMouseEvent(b,a,c){this._isExportToVideo||
IsCompatibilityMouseEvent(a)||this._PostToRuntimeMaybeSync(b,{button:a.button,buttons:a.buttons,clientX:a.clientX,clientY:a.clientY+this._vkTranslateYOffset,pageX:a.pageX,pageY:a.pageY+this._vkTranslateYOffset,movementX:a.movementX||0,movementY:a.movementY||0,timeStamp:a.timeStamp},c)}_OnMouseEventAsPointer(b,a){if(!this._isExportToVideo&&!IsCompatibilityMouseEvent(a)){var c=this._mousePointerLastButtons;"pointerdown"===b&&0!==c?b="pointermove":"pointerup"===b&&0!==a.buttons&&(b="pointermove");this._PostToRuntimeMaybeSync(b,
{pointerId:1,pointerType:"mouse",button:a.button,buttons:a.buttons,lastButtons:c,clientX:a.clientX,clientY:a.clientY+this._vkTranslateYOffset,pageX:a.pageX,pageY:a.pageY+this._vkTranslateYOffset,movementX:a.movementX||0,movementY:a.movementY||0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,timeStamp:a.timeStamp},DISPATCH_RUNTIME_AND_SCRIPT);this._mousePointerLastButtons=a.buttons;this._OnMouseEvent(a.type,a,DISPATCH_SCRIPT_ONLY)}}_OnPointerEvent(b,a){if(!this._isExportToVideo){var c=
0;"mouse"===a.pointerType&&(c=this._mousePointerLastButtons);this._PostToRuntimeMaybeSync(b,{pointerId:a.pointerId,pointerType:a.pointerType,button:a.button,buttons:a.buttons,lastButtons:c,clientX:a.clientX,clientY:a.clientY+this._vkTranslateYOffset,pageX:a.pageX,pageY:a.pageY+this._vkTranslateYOffset,movementX:a.movementX||0,movementY:a.movementY||0,width:a.width||0,height:a.height||0,pressure:a.pressure||0,tangentialPressure:a.tangentialPressure||0,tiltX:a.tiltX||0,tiltY:a.tiltY||0,twist:a.twist||
0,timeStamp:a.timeStamp},DISPATCH_RUNTIME_AND_SCRIPT);"mouse"===a.pointerType&&(c="mousemove","pointerdown"===b?c="mousedown":"pointerup"===b&&(c="mouseup"),this._OnMouseEvent(c,a,DISPATCH_SCRIPT_ONLY),this._mousePointerLastButtons=a.buttons)}}_OnPointerRawUpdate(b){this._OnPointerEvent("pointermove",b)}_OnTouchEvent(b,a){if(!this._isExportToVideo)for(let c=0,d=a.changedTouches.length;c<d;++c){const e=a.changedTouches[c];this._PostToRuntimeMaybeSync(b,{pointerId:e.identifier,pointerType:"touch",button:0,
buttons:0,lastButtons:0,clientX:e.clientX,clientY:e.clientY+this._vkTranslateYOffset,pageX:e.pageX,pageY:e.pageY+this._vkTranslateYOffset,movementX:a.movementX||0,movementY:a.movementY||0,width:2*(e.radiusX||e.webkitRadiusX||0),height:2*(e.radiusY||e.webkitRadiusY||0),pressure:e.force||e.webkitForce||0,tangentialPressure:0,tiltX:0,tiltY:0,twist:e.rotationAngle||0,timeStamp:a.timeStamp},DISPATCH_RUNTIME_AND_SCRIPT)}}_HandlePointerDownFocus(b){window!==window.top&&window.focus();this._IsElementCanvasOrDocument(b.target)&&
document.activeElement&&!this._IsElementCanvasOrDocument(document.activeElement)&&document.activeElement.blur()}_IsElementCanvasOrDocument(b){return!b||b===document||b===window||b===document.body||"canvas"===b.tagName.toLowerCase()}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",b=>this._OnDeviceOrientation(b)),window.addEventListener("deviceorientationabsolute",b=>this._OnDeviceOrientationAbsolute(b)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||
(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",b=>this._OnDeviceMotion(b)))}_OnDeviceOrientation(b){this._isExportToVideo||this.PostToRuntime("deviceorientation",{absolute:!!b.absolute,alpha:b.alpha||0,beta:b.beta||0,gamma:b.gamma||0,timeStamp:b.timeStamp,webkitCompassHeading:b.webkitCompassHeading,webkitCompassAccuracy:b.webkitCompassAccuracy},DISPATCH_RUNTIME_AND_SCRIPT)}_OnDeviceOrientationAbsolute(b){this._isExportToVideo||this.PostToRuntime("deviceorientationabsolute",
{absolute:!!b.absolute,alpha:b.alpha||0,beta:b.beta||0,gamma:b.gamma||0,timeStamp:b.timeStamp},DISPATCH_RUNTIME_AND_SCRIPT)}_OnDeviceMotion(b){if(!this._isExportToVideo){var a=null,c=b.acceleration;c&&(a={x:c.x||0,y:c.y||0,z:c.z||0});c=null;var d=b.accelerationIncludingGravity;d&&(c={x:d.x||0,y:d.y||0,z:d.z||0});d=null;var e=b.rotationRate;e&&(d={alpha:e.alpha||0,beta:e.beta||0,gamma:e.gamma||0});this.PostToRuntime("devicemotion",{acceleration:a,accelerationIncludingGravity:c,rotationRate:d,interval:b.interval,
timeStamp:b.timeStamp},DISPATCH_RUNTIME_AND_SCRIPT)}}_OnUpdateCanvasSize(b){var a=this.GetRuntimeInterface();a.IsExportingToVideo()||(a=a.GetCanvas(),a.style.width=b.styleWidth+"px",a.style.height=b.styleHeight+"px",a.style.marginLeft=b.marginLeft+"px",a.style.marginTop=b.marginTop+"px",document.documentElement.style.setProperty("--construct-scale",b.displayScale),this._isFirstSizeUpdate&&(a.style.display="",this._isFirstSizeUpdate=!1))}_OnInvokeDownload(b){const a=b.url;b=b.filename;const c=document.createElement("a"),
d=document.body;c.textContent=b;c.href=a;c.download=b;d.appendChild(c);c.click();d.removeChild(c)}async _OnLoadWebFonts(b){await Promise.all(b.webfonts.map(async a=>{a=new FontFace(a.name,`url('${a.url}')`);document.fonts.add(a);await a.load()}))}async _OnRasterSvgImage(b){var a=b.imageBitmapOpts;b=await self.C3_RasterSvgImageBlob(b.blob,b.imageWidth,b.imageHeight,b.surfaceWidth,b.surfaceHeight);a=a?await createImageBitmap(b,a):await createImageBitmap(b);return{imageBitmap:a,transferables:[a]}}async _OnGetSvgImageSize(b){return await self.C3_GetSvgImageSize(b.blob)}async _OnAddStylesheet(b){await AddStyleSheet(b.url)}_PlayPendingMedia(){var b=
[...this._mediaPendingPlay];this._mediaPendingPlay.clear();if(!this._isSilent)for(const a of b)(b=a.play())&&b.catch(c=>{this._mediaRemovedPendingPlay.has(a)||this._mediaPendingPlay.add(a)})}TryPlayMedia(b){if("function"!==typeof b.play)throw Error("missing play function");this._mediaRemovedPendingPlay.delete(b);let a;try{a=b.play()}catch(c){this._mediaPendingPlay.add(b);return}a&&a.catch(c=>{this._mediaRemovedPendingPlay.has(b)||this._mediaPendingPlay.add(b)})}RemovePendingPlay(b){this._mediaPendingPlay.delete(b);
this._mediaRemovedPendingPlay.add(b)}SetSilent(b){this._isSilent=!!b}_OnHideCordovaSplash(){navigator.splashscreen&&navigator.splashscreen.hide&&navigator.splashscreen.hide()}_OnDebugHighlight(b){if(b.show){this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));var a=this._debugHighlightElem;a.style.display="";a.style.left=b.left-1+"px";a.style.top=b.top-1+"px";a.style.width=
b.width+2+"px";a.style.height=b.height+2+"px";a.textContent=b.name}else this._debugHighlightElem&&(this._debugHighlightElem.style.display="none")}_OnRegisterSW(){window.C3_RegisterSW&&window.C3_RegisterSW()}_OnPostToDebugger(b){window.c3_postToMessagePort&&(b.from="runtime",window.c3_postToMessagePort(b))}_InvokeFunctionFromJS(b,a){return this.PostToRuntimeAsync("js-invoke-function",{name:b,params:a})}_OnScriptCreateWorker(b){const a=b.port2;(new Worker(b.url,b.opts)).postMessage({type:"construct-worker-init",
port2:a},[a])}_OnAlert(b){alert(b.message)}_OnWrapperMessage(b){"entered-fullscreen"===b?(RuntimeInterface$jscomp$1._SetWrapperIsFullscreenFlag(!0),this._OnFullscreenChange()):"exited-fullscreen"===b?(RuntimeInterface$jscomp$1._SetWrapperIsFullscreenFlag(!1),this._OnFullscreenChange()):console.warn("Unknown wrapper message: ",b)}_OnScreenReaderTextEvent(b){var a=b.type;"create"===a?(a=document.createElement("p"),a.id="c3-sr-"+b.id,a.textContent=b.text,this._screenReaderTextWrap.appendChild(a)):"update"===
a?(a=document.getElementById("c3-sr-"+b.id))?a.textContent=b.text:console.warn(`[Construct] Missing screen reader text with id ${b.id}`):"release"===a?(a=document.getElementById("c3-sr-"+b.id))?a.remove():console.warn(`[Construct] Missing screen reader text with id ${b.id}`):console.warn(`[Construct] Unknown screen reader text update '${a}'`)}_SetExportingToVideo(b){this._isExportToVideo=!0;const a=document.createElement("h1");a.id="exportToVideoMessage";a.textContent=b.message;document.body.prepend(a);
document.body.classList.add("exportingToVideo");this.GetRuntimeInterface().GetCanvas().style.display="";this._iRuntime.SetIsExportingToVideo(b.duration)}_OnExportVideoProgress(b){this._exportVideoProgressMessage=b.message;-1===this._exportVideoUpdateTimerId&&(this._exportVideoUpdateTimerId=setTimeout(()=>this._DoUpdateExportVideoProgressMessage(),250))}_DoUpdateExportVideoProgressMessage(){this._exportVideoUpdateTimerId=-1;const b=document.getElementById("exportToVideoMessage");b&&(b.textContent=
this._exportVideoProgressMessage)}_OnExportedToVideo(b){window.c3_postToMessagePort({type:"exported-video",blob:b.blob,time:b.time})}_OnExportedToImageSequence(b){window.c3_postToMessagePort({type:"exported-image-sequence",blobArr:b.blobArr,time:b.time,gif:b.gif})}});"use strict";
self.JobSchedulerDOM=class{constructor(b){this._runtimeInterface=b;this._baseUrl=b.GetRuntimeBaseURL();"preview"===b.GetExportType()?this._baseUrl+="workers/":this._baseUrl+=b.GetScriptFolder();this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16);this._dispatchWorker=null;this._jobWorkers=[];this._outputPort=this._inputPort=null}_GetWorkerScriptFolder(){return"playable-ad"===this._runtimeInterface.GetExportType()?this._runtimeInterface.GetScriptFolder():""}async Init(){if(this._hasInitialised)throw Error("already initialised");
this._hasInitialised=!0;var b=this._runtimeInterface._GetWorkerURL(this._GetWorkerScriptFolder()+"dispatchworker.js");this._dispatchWorker=await this._runtimeInterface.CreateWorker(b,this._baseUrl,{name:"DispatchWorker"});b=new MessageChannel;this._inputPort=b.port1;this._dispatchWorker.postMessage({type:"_init","in-port":b.port2},[b.port2]);this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const b=this._jobWorkers.length;var a=this._runtimeInterface._GetWorkerURL(this._GetWorkerScriptFolder()+
"jobworker.js");a=await this._runtimeInterface.CreateWorker(a,this._baseUrl,{name:"JobWorker"+b});const c=new MessageChannel,d=new MessageChannel;this._dispatchWorker.postMessage({type:"_addJobWorker",port:c.port1},[c.port1]);a.postMessage({type:"init",number:b,"dispatch-port":c.port2,"output-port":d.port2},[c.port2,d.port2]);this._jobWorkers.push(a);return d.port1}GetPortData(){return{inputPort:this._inputPort,outputPort:this._outputPort,maxNumWorkers:this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,
this._outputPort]}};"use strict";window.C3_IsSupported&&(window.c3_runtimeInterface=new self.RuntimeInterface({useWorker:!0,workerMainUrl:"workermain.js",engineScripts:["scripts/c3runtime.js"],projectScripts:[],mainProjectScript:"",scriptFolder:"scripts/",workerDependencyScripts:[],exportType:"html5"}));"use strict";function StopPropagation(b){b.stopPropagation()}function StopKeyPropagation(b){13!==b.which&&27!==b.which&&b.stopPropagation()}
self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMElementHandler{constructor(b){super(b,"text-input");this.AddDOMElementMessageHandler("scroll-to-bottom",a=>this._OnScrollToBottom(a))}CreateElement(b,a){let c;const d=a.type;"textarea"===d?(c=document.createElement("textarea"),c.style.resize="none"):(c=document.createElement("input"),c.type=d);c.style.position="absolute";c.autocomplete="off";c.addEventListener("pointerdown",StopPropagation);c.addEventListener("pointermove",StopPropagation);
c.addEventListener("pointerrawupdate",StopPropagation);c.addEventListener("pointerup",StopPropagation);c.addEventListener("mousedown",StopPropagation);c.addEventListener("mouseup",StopPropagation);c.addEventListener("keydown",StopKeyPropagation);c.addEventListener("keyup",StopKeyPropagation);c.addEventListener("click",e=>{e.stopPropagation();this._PostToRuntimeElementMaybeSync("click",b)});c.addEventListener("dblclick",e=>{e.stopPropagation();this._PostToRuntimeElementMaybeSync("dblclick",b)});c.addEventListener("input",
()=>this.PostToRuntimeElement("change",b,{text:c.value}));a.id&&(c.id=a.id);a.className&&(c.className=a.className);this.UpdateState(c,a);return c}UpdateState(b,a){b.value=a.text;b.placeholder=a.placeholder;b.title=a.title;b.disabled=!a.isEnabled;b.readOnly=a.isReadOnly;b.spellcheck=a.spellCheck;a=a.maxLength;0>a?b.removeAttribute("maxlength"):b.setAttribute("maxlength",a)}_OnScrollToBottom(b){b.scrollTop=b.scrollHeight}});"use strict";function StopPropagation$jscomp$1(b){b.stopPropagation()}
self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMElementHandler{constructor(b){super(b,"button")}CreateElement(b,a){const c=document.createElement("input");var d=c;a.isCheckbox?(c.type="checkbox",d=document.createElement("label"),d.appendChild(c),d.appendChild(document.createTextNode("")),d.style.fontFamily="sans-serif",d.style.userSelect="none",d.style.webkitUserSelect="none",d.style.display="inline-block",d.style.color="black"):c.type="button";d.style.position="absolute";d.addEventListener("pointerdown",
StopPropagation$jscomp$1);d.addEventListener("pointermove",StopPropagation$jscomp$1);d.addEventListener("pointerrawupdate",StopPropagation$jscomp$1);d.addEventListener("pointerup",StopPropagation$jscomp$1);d.addEventListener("mousedown",StopPropagation$jscomp$1);d.addEventListener("mouseup",StopPropagation$jscomp$1);d.addEventListener("keydown",StopPropagation$jscomp$1);d.addEventListener("keyup",StopPropagation$jscomp$1);c.addEventListener("click",()=>this._PostToRuntimeElementMaybeSync("click",
b,{isChecked:c.checked}));a.id&&(c.id=a.id);a.className&&(c.className=a.className);this.UpdateState(d,a);return d}_GetInputElem(b){return"input"===b.tagName.toLowerCase()?b:b.firstChild}_GetFocusElement(b){return this._GetInputElem(b)}UpdateState(b,a){const c=this._GetInputElem(b);c.checked=a.isChecked;c.disabled=!a.isEnabled;b.title=a.title;b===c?c.value=a.text:b.lastChild.textContent=a.text}});"use strict";function StopPropagation$jscomp$2(b){b.stopPropagation()}
self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMElementHandler{constructor(b){super(b,"list");this.AddDOMElementMessageHandler("set-selected-index",(a,c)=>this._OnSetSelectedIndex(a,c.selectedIndex));this.AddDOMElementMessageHandler("add-item",(a,c)=>this._OnAddItem(a,c));this.AddDOMElementMessageHandler("remove-item",(a,c)=>this._OnRemoveItem(a,c));this.AddDOMElementMessageHandler("set-item",(a,c)=>this._OnSetItem(a,c));this.AddDOMElementMessageHandler("clear",a=>this._OnClear(a));
this.AddDOMElementMessageHandler("load-state",(a,c)=>this._OnLoadState(a,c))}CreateElement(b,a){const c=a.isDropdown,d=a.isMultiSelect,e=a.items,f=document.createElement("select");f.style.position="absolute";f.style.userSelect="none";f.style.webkitUserSelect="none";f.multiple=d;c||(f.size=2);for(const g of e)f.add(this._CreateOption(g));f.addEventListener("pointerdown",StopPropagation$jscomp$2);f.addEventListener("pointermove",StopPropagation$jscomp$2);f.addEventListener("pointerrawupdate",StopPropagation$jscomp$2);
f.addEventListener("pointerup",StopPropagation$jscomp$2);f.addEventListener("mousedown",StopPropagation$jscomp$2);f.addEventListener("mouseup",StopPropagation$jscomp$2);f.addEventListener("click",g=>{g.stopPropagation();this._PostToRuntimeElementMaybeSync("click",b,this._GetSelectionState(f))});f.addEventListener("dblclick",g=>{g.stopPropagation();this._PostToRuntimeElementMaybeSync("dblclick",b,this._GetSelectionState(f))});f.addEventListener("change",()=>this.PostToRuntimeElement("change",b,this._GetSelectionState(f)));
a.id&&(f.id=a.id);a.className&&(f.className=a.className);this.UpdateState(f,a);return f}_CreateOption(b){const a=document.createElement("option");a.text=b;return a}_GetSelectionState(b){const a=b.selectedIndex,c=[];for(let d=0,e=b.length;d<e;++d)b.options[d].selected&&c.push(d);return{selectedIndex:a,selectedIndices:c}}UpdateState(b,a){b.title=a.title;b.disabled=!a.isEnabled;b.multiple=!!a.isMultiSelect}_OnSetSelectedIndex(b,a){b.selectedIndex=a}_OnAddItem(b,a){const c=a.index;a=this._CreateOption(a.text);
0>c?b.add(a):b.add(a,c)}_OnRemoveItem(b,a){b.remove(a.index)}_OnSetItem(b,a){b.options[a.index].text=a.text}_OnClear(b){b.innerHTML=""}_OnLoadState(b,a){b.innerHTML="";for(const c of a.items)b.add(this._CreateOption(c));b.selectedIndex=a.selectedIndex;for(const c of a.selectedIndices)if(a=b.options[c])a.selected=!0}});"use strict";const toRemove=[],TWO_PI=2*Math.PI;function clampAngle(b){b%=TWO_PI;0>b&&(b+=TWO_PI);return b}function clamp(b,a,c){return b<a?a:b>c?c:b}
function lerp(b,a,c){return b+c*(a-b)}function unlerp(b,a,c){return b===a?0:(c-b)/(a-b)}function angleDiff(b,a){if(b===a)return 0;b=Math.sin(b)*Math.sin(a)+Math.cos(b)*Math.cos(a);return 1<=b?0:-1>=b?Math.PI:Math.acos(b)}function angleClockwise(b,a){return 0>=Math.cos(b)*Math.sin(a)-Math.sin(b)*Math.cos(a)}function angleLerp(b,a,c){const d=angleDiff(b,a);return angleClockwise(a,b)?clampAngle(b+d*c):clampAngle(b-d*c)}
class C3NetValue{constructor(b,a,c,d,e,f){this._index=b;this._interp=a;this._precision=c;this._tag=d;this._userData=e;this._clientValueTag=f}GetRuntimeData(){return{tag:this._tag,interp:this._interp,userData:this._userData,cvt:this._clientValueTag}}GetIndex(){return this._index}GetInterp(){return this._interp}GetPrecision(){return this._precision}GetTag(){return this._tag}HasUserData(){return"undefined"!==typeof this._userData}GetUserData(){return this._userData}GetClientValueTag(){return this._clientValueTag}Clamp(b){switch(this._precision){case 0:return b;
case 1:return Math.fround(b);case 2:return 2===this._interp&&(b=clampAngle(b),b/=Math.PI,b=32767*(b-1)),clamp(b|0,-32768,32767);case 3:return 2===this._interp&&(b=clampAngle(b),b/=TWO_PI,b*=255),clamp(b|0,0,255);default:return b}}Write(b,a,c){switch(this._precision){case 0:b.setFloat64(a,c);a+=8;break;case 1:b.setFloat32(a,c);a+=4;break;case 2:b.setInt16(a,c);a+=2;break;case 3:b.setUint8(a,c);a+=1;break;default:b.setFloat32(a,c),a+=4}return a}MaybeUnpack(b){if(2!==this._interp)return b;2===this._precision?
b=(b/32767+1)*Math.PI:3===this._precision&&(b=b/255*TWO_PI);return b}static InterpNetValue(b,a,c,d,e){switch(b){case 0:return e?c:a;case 1:return lerp(a,c,d);case 2:return angleLerp(a,c,d);default:return e?c:a}}}class C3NetUpdate{constructor(b,a){this.timestamp=b;this.data=a}}
class C3NetInstance{constructor(b,a,c){this._ro=b;this._domHandler=b.GetDOMHandler();this._id=a;this._nid=c;this._data=[];this._data.length=this._ro.GetNetValues().length;this._lastTransmitted=this._lastChanged=0;this._isAlive=this._transmitMe=!1;this._updates=[];this._nextUpdate=this._priorUpdate=this._priorUpdate2=null}GetRuntimeData(){var b=[];for(let c=0,d=this._ro.GetNetValues().length;c<d;++c)b.push(this.GetInterp(this._ro.GetSimTime(),c));b={id:this._id,nid:this._nid,isTimedOut:this.IsTimedOut(),
interpValues:b,latestUpdate:null};const a=this.GetLatestUpdate();a&&(b.latestUpdate={timestamp:a.timestamp,data:a.data});return b}GetId(){return this._id}GetNid(){return this._nid}SetAlive(b){this._isAlive=!!b}IsAlive(){return this._isAlive}ShouldTransmit(){return this._transmitMe}UpdateData(b,a){b=b.netValues;var c=this._ro.GetNetValues();const d=c.length;this._transmitMe=!1;for(let e=0;e<d;++e){const f=c[e].Clamp(b[e]);this._data[e]!==f&&(this._data[e]=f,this._lastChanged=a,this._ro.SetLastChanged(a))}b=
a-this._lastChanged;a-=this._lastTransmitted;c=this._ro.GetBandwidth();(this._transmitMe=100>b&&0===c?!0:1E3>b&&1>=c?95<=a:495<=a)&&this._ro.IncNumberToTransmit()}WriteData(b,a,c){const d=this._ro.GetNetValues();this._lastTransmitted=c;b.setUint16(a,this._nid);a+=2;for(let e=0,f=this._data.length;e<f;++e)a=d[e].Write(b,a,this._data[e]);return a}AddUpdate(b,a){for(let c=0,d=this._updates.length;c<d;++c){const e=this._updates[c];if(e.timestamp===b)return;if(e.timestamp>b){this._updates.splice(c,0,new C3NetUpdate(b,
a));return}}this._updates.push(new C3NetUpdate(b,a))}IsTimedOut(){return 0===this._updates.length?!1:this._updates[this._updates.length-1].timestamp<this._ro.GetSimTime()-3E3}Tick(){for(;2<this._updates.length&&this._updates[0]!==this._priorUpdate2&&this._updates[0]!==this._priorUpdate&&this._updates[0]!==this._nextUpdate;)this._updates.shift();const b=this._ro.GetSimTime();if(!(this._nextUpdate&&this._nextUpdate.timestamp>b&&this._priorUpdate&&this._priorUpdate.timestamp<b)){this._nextUpdate=null;
for(let a=0,c=this._updates.length;a<c;++a){const d=this._updates[a];if(d.timestamp<=b){if(!this._priorUpdate||d.timestamp>this._priorUpdate.timestamp)this._priorUpdate2=this._priorUpdate,this._priorUpdate=d}else{this._nextUpdate=d;break}}}}GetLatestUpdate(){return 0===this._updates.length?null:this._updates[this._updates.length-1]}GetInterp(b,a,c){if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate)return this._nextUpdate.data[a];const d=this._ro.GetNetValues();
let e,f,g;if(!this._nextUpdate&&this._priorUpdate)return this._priorUpdate2&&!c?(e=this._priorUpdate2.timestamp,c=this._priorUpdate2.data[a],f=this._priorUpdate.timestamp,g=this._priorUpdate.data[a],b>this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()&&(b=this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()),b=unlerp(e,f,b),C3NetValue.InterpNetValue(d[a].GetInterp(),c,g,b,!0)):this._priorUpdate.data[a];e=this._priorUpdate.timestamp;c=this._priorUpdate.data[a];f=this._nextUpdate.timestamp;
g=this._nextUpdate.data[a];b=unlerp(e,f,b);return C3NetValue.InterpNetValue(d[a].GetInterp(),c,g,b,!1)}}
class C3RegisteredObject{constructor(b,a,c,d){this._domHandler=b;this._roId=a;this._sid=c;this._nid=this._domHandler.GetNextObjectNid();this._bandwidth=d;this._userData={};this._instanceByteSize=0;this._extrapolateLimit=250;switch(this._bandwidth){case 1:this._extrapolateLimit=500;break;case 2:this._extrapolateLimit=2500}this._netValues=[];this._netInstances=[];this._idToNetInst=new Map;this._usedNids=new Set;this._numberToTransmit=this._lastTransmitted=this._lastChanged=this._nextNid=0;this._hasOverriddenNids=
!1;this._deadNids=[];this._overrideNids=new Map;this._nidToNetInst=new Map;this._simTime=0;this._domHandler.AddRegisteredObject(this)}GetDOMHandler(){return this._domHandler}GetNetValues(){return this._netValues}GetRoId(){return this._roId}_SetNid(b){this._nid=b}GetNid(){return this._nid}SetLastChanged(b){this._lastChanged=b}GetBandwidth(){return this._bandwidth}IncNumberToTransmit(){this._numberToTransmit++}GetNumberToTransmit(){return this._numberToTransmit}GetSimTime(){return this._simTime}_SetHasOverriddenNids(b){this._hasOverriddenNids=
!!b}HasOverriddenNids(){return this._hasOverriddenNids}GetExtrapolateLimit(){return this._extrapolateLimit}GetSid(){return this._sid}GetDeadNids(){return this._deadNids}AddValue(b,a,c,d,e){b=new C3NetValue(this._netValues.length,b,a,c,d,e);switch(a){case 0:this._instanceByteSize+=8;break;case 1:this._instanceByteSize+=4;break;case 2:this._instanceByteSize+=2;break;case 3:this._instanceByteSize+=1}this._netValues.push(b)}AddUpdate(b,a,c){this.GetNetInstForNid(a).AddUpdate(b,c)}Tick(){this._simTime=
this._domHandler.GetSimulationTime();for(const b of this._netInstances)b.Tick()}GetCount(){return this._netInstances.length}GetNetInstAt(b){b=Math.floor(b);return 0>b||b>=this._netInstances.length?null:this._netInstances[b]}GetNetInstByNid(b){for(const a of this._netInstances)if(a.GetNid()===b)return a;return null}GetNetValuesJson(){const b=[];for(const a of this._netValues){const c={tag:a.GetTag(),precision:a.GetPrecision(),interp:a.GetInterp(),clientvaluetag:a.GetClientValueTag()};a.HasUserData()&&
(c.userdata=a.GetUserData());b.push(c)}return b}SetNetValuesFrom(b){this._instanceByteSize=this._netValues.length=0;for(const a of b)this.AddValue(a.interp,a.precision,a.tag,a.userdata,a.clientvaluetag)}GetNetInstForNid(b){let a=this._nidToNetInst.get(b);if(a)return a;a=new C3NetInstance(this,-1,b);this._nidToNetInst.set(b,a);this._netInstances.push(a);return a}GetNetInstForId(b){let a=this._idToNetInst.get(b);if(a)return a;a=new C3NetInstance(this,b,this.AllocateInstanceNid());this._idToNetInst.set(b,
a);this._netInstances.push(a);return a}AllocateInstanceNid(){do this._nextNid++,65535<this._nextNid&&(this._nextNid=0);while(this._usedNids.has(this._nextNid));const b=this._nextNid;this._usedNids.add(b);return b}RemoveNetInstance(b){const a=b.GetId(),c=b.GetNid();this._domHandler.IsHost()&&!this._hasOverriddenNids&&this._deadNids.push(c);this._idToNetInst.delete(a);this._nidToNetInst.delete(c);this._usedNids.delete(c);b=this._netInstances.indexOf(b);-1<b&&this._netInstances.splice(b,1)}ClearAllNetInstances(){this._deadNids.length=
0;this._idToNetInst.clear();this._nidToNetInst.clear();this._usedNids.clear();this._netInstances.length=0}UpdateData(b,a){this._numberToTransmit=0;for(var c of this._netInstances)c.SetAlive(!1);for(let d=0,e=b.length;d<e;++d){c=b[d];const f=this.GetNetInstForId(c.uid);f.SetAlive(!0);f.UpdateData(c,a)}for(const d of this._netInstances)d.IsAlive()||toRemove.push(d);for(const d of toRemove)this.RemoveNetInstance(d);toRemove.length=0}WriteData(b,a,c){b.setUint16(a,this._nid);a+=2;let d=0;this._hasOverriddenNids&&
(d=1);b.setUint8(a,d);a+=1;b.setUint16(a,this._numberToTransmit);a+=2;b.setUint16(a,this._instanceByteSize);a+=2;for(const e of this._netInstances)e.ShouldTransmit()&&(a=e.WriteData(b,a,c));return a}OverrideNid(b,a){if(this._idToNetInst.has(b))console.warn("OverrideNid passed id "+b+" which is already in use and cannot be overridden");else if(this._usedNids.has(a))console.warn("OverrideNid passed nid "+a+" which is already in use and cannot be overridden");else{var c=new C3NetInstance(this,b,a);this._idToNetInst.set(b,
c);this._usedNids.add(a);this._netInstances.push(c);this._hasOverriddenNids=!0;return c}}RemoveObjectId(b){(b=this._idToNetInst.get(b))&&this.RemoveNetInstance(b)}RemoveObjectNid(b){(b=this._nidToNetInst.get(b))&&this.RemoveNetInstance(b)}GetRuntimeData(){return{hasOverriddenNids:this.HasOverriddenNids(),netValues:this._netValues.map(b=>b.GetRuntimeData()),netInstances:this._netInstances.map(b=>b.GetRuntimeData())}}GetRuntimeInfoRequest(){return{roId:this._roId,sid:this._sid,netValues:this._netValues.map(b=>
b.GetRuntimeData())}}}self.C3NetValue=C3NetValue;self.C3NetUpdate=C3NetUpdate;self.C3RegisteredObject=C3RegisteredObject;"use strict";const C3NetUpdate$jscomp$1=self.C3NetUpdate,C3NetValue$jscomp$1=self.C3NetValue,RTCPeerConnection$jscomp$1=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection;function CloseIgnoreException(b){if(b)try{b.close()}catch(a){}}const tempArray=[];function unlerp$jscomp$1(b,a,c){return b===a?0:(c-b)/(a-b)}
function Wait(b){return new Promise(a=>setTimeout(a,b))}class PromiseThrottle{constructor(b=1){this._maxParallel=b;this._queue=[];this._activeCount=0}Add(b){return new Promise((a,c)=>{this._queue.push({func:b,resolve:a,reject:c});this._MaybeStartNext()})}async _MaybeStartNext(){if(this._queue.length&&!(this._activeCount>=this._maxParallel)){this._activeCount++;var b=this._queue.shift();try{const a=await b.func();b.resolve(a)}catch(a){b.reject(a)}this._activeCount--;this._MaybeStartNext()}}}
class C3Peer{constructor(b,a,c){this._domHandler=b;this._id=a;this._nid=0;this._alias=c;this._dco=this._pc=null;this._isOOpen=!1;this._dcr=null;this._isROpen=!1;this._dcu=null;this._isUOpen=!1;this._sendThrottle=new PromiseThrottle(1);this._receiveThrottle=new PromiseThrottle(1);this._hasConfirmed=this._wasRemoved=this._firedClose=this._firedOpen=!1;this._errorCount=this._connectTime=this._lastHeardFrom=0;this._availableCompressionFormats=[];this._localClientState=[];this._lastStateTransmit=this._lastStateChange=
0;this._clientStateUpdates=[];this._nextUpdate=this._priorUpdate=this._priorUpdate2=null;this._lastPingSent=0;this._awaitingPong=!1;this._lastSentPingId=1;this._lastPingTimes=[];this._pdv=this._latency=0;this._domHandler._AddPeer(this)}GetId(){return this._id}GetNid(){return this._nid}_SetNid(b){this._nid=b}GetAlias(){return this._alias}IsHost(){return this===this._domHandler.GetHostPeer()}IsSelf(){return this===this._domHandler.GetSelfPeer()}GetLocalClientState(){return this._localClientState}_SetLastStateChange(b){this._lastStateChange=
b}GetLastStateChange(){return this._lastStateChange}_SetLastStateTransmit(b){this._lastStateTransmit=b}GetLastStateTransmit(){return this._lastStateTransmit}GetLatency(){return this._latency}GetPdv(){return this._pdv}_AttachDataChannelHandlers(b,a){b.binaryType="arraybuffer";b.onopen=()=>{"o"===a?this._isOOpen=!0:"r"===a?this._isROpen=!0:"u"===a&&(this._isUOpen=!0);this._MaybeFireOpen()};b.onmessage=c=>{this._OnNetworkMessage(a,c)};b.onerror=c=>{console.error("Peer '"+this._id+"' datachannel '"+a+
"' error: ",c);this._domHandler._OnPeerError(this,c);this._domHandler.IsHost()&&!this.IsHost()&&this.Remove("network error")};b.onclose=()=>{this.Remove("disconnect")}}Connect(){if(!this.IsSelf()){var b=this._domHandler.IsHost();this._firedClose=this._firedOpen=this._isUOpen=this._isROpen=this._isOOpen=!1;this._connectTime=performance.now();this._pc=new RTCPeerConnection$jscomp$1({iceServers:this._domHandler.GetICEServerList()});this._pc.onicecandidate=c=>{c.candidate&&this._domHandler.SignallingSend({message:"icecandidate",
toclientid:this._id,icecandidate:c.candidate})};this._pc.onsignalingstatechange=()=>{this._pc&&"closed"===this._pc.signalingState&&this.Remove("disconnect")};this._pc.oniceconnectionstatechange=()=>{this._pc&&("failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState||this.Remove("disconnect"))};this._pc.onconnectionstatechange=()=>{if(this._pc){var c=this._pc.connectionState;"failed"!==c&&"closed"!==c||this.Remove("disconnect")}};var a=`c3mp_${this._domHandler.GetCurrentGame()}_${this._domHandler.GetCurrentGameInstance()}_${this._domHandler.GetCurrentRoom()}`;
b?(this._nid=this._domHandler.AllocatePeerNid(),this._dco=this._pc.createDataChannel("o",{ordered:!0,protocol:a}),this._AttachDataChannelHandlers(this._dco,"o"),this._dcr=this._pc.createDataChannel("r",{ordered:!1,protocol:a}),this._AttachDataChannelHandlers(this._dcr,"r"),this._dcu=this._pc.createDataChannel("u",{ordered:!1,maxRetransmits:0,protocol:a}),this._AttachDataChannelHandlers(this._dcu,"u"),this._pc.createOffer().then(c=>{this._pc.setLocalDescription(c);this._domHandler.SignallingSend({message:"offer",
toclientid:this._id,offer:c})}).catch(c=>{console.error("Host error creating offer for peer '"+this._id+"': ",c);this._domHandler._OnPeerError(this,"could not create offer for peer")})):this._pc.ondatachannel=c=>{if(c.channel.protocol!==a)console.error("Unexpected datachannel protocol '"+c.channel.protocol+"', should be '"+a+"'"),this._domHandler._OnPeerError(this,"unexpected datachannel protocol '"+c.channel.protocol+"', should be '"+a+"'"),this._wasRemoved||(this.Remove("datachannel protocol error"),
this._domHandler.OnWasKicked());else{var d=c.channel.label;"o"===d?this._dco=c.channel:"r"===d?this._dcr=c.channel:"u"===d?this._dcu=c.channel:(console.error("Unknown datachannel label: "+c.channel.label),this._domHandler._OnPeerError(this,"unknown datachannel label '"+c.channel.label+"'"));this._AttachDataChannelHandlers(c.channel,d)}}}}async _AddICECandidate(b){if(this._pc)try{await this._pc.addIceCandidate(b)}catch(a){console.warn("[Multiplayer] Error adding ICE candidate: ",a)}}HasPeerConnection(){return!!this._pc}GetPeerConnection(){return this._pc}_MaybeFireOpen(){!this._firedOpen&&
this._isROpen&&this._isUOpen&&this._isOOpen&&(this._OnOpen(),this._firedOpen=!0,this._firedClose=!1)}_OnOpen(){this._lastHeardFrom=performance.now();if(this._domHandler.IsHost()){this._domHandler.HostBroadcast("o",JSON.stringify({c:"j",i:this._id,n:this._nid,a:this._alias}),0,this);this.Send("o",JSON.stringify({c:"hi",hn:this._domHandler.GetHostPeer().GetNid(),n:this._nid,d:this._domHandler.GetClientDelay(),u:this._domHandler.GetPeerUpdateRateSec(),objs:this._domHandler.GetRegisteredObjectsMap(),
cvs:this._domHandler.GetClientValuesJson(),comp:this._domHandler.GetLocalSupportedCompressionFormats()}));for(const b of this._domHandler.peers())!b.IsHost()&&b!==this&&b.IsOpen()&&this.Send("o",JSON.stringify({c:"j",i:b.GetId(),n:b.GetNid(),a:b.GetAlias()}))}else this._hasConfirmed=!0,this.IsHost()&&this.SendPing(performance.now(),!0),this.Send("o",JSON.stringify({c:"comp",comp:this._domHandler.GetLocalSupportedCompressionFormats()}));this._domHandler._OnPeerOpen(this)}_MaybeFireClose(b){!this._firedClose&&
this._firedOpen&&(this._OnClose(b),this._firedClose=!0,this._firedOpen=!1)}_OnClose(b){this._domHandler.IsHost()&&!this.IsSelf()&&this._domHandler.HostBroadcast("o",JSON.stringify({c:"l",i:this._id,a:this._alias,r:b}),0,this);this.IsSelf()||this._domHandler._OnPeerClose(this,b)}IsOpen(){return this._firedOpen&&!this._firedClose}_DetermineSupportedCompressionFormats(b){const a=this._domHandler.GetLocalSupportedCompressionFormats();for(const c of b)a.includes(c)&&this._availableCompressionFormats.push(c)}async _MaybeCompress(b){if(0===
this._availableCompressionFormats.length)return{compressionType:0,data:b};const a=new Blob([b]);if(64>a.size)return{compressionType:0,data:b};const c=this._availableCompressionFormats[0];var d=new CompressionStream(c);d=a.stream().pipeThrough(d);d=await (new Response(d)).arrayBuffer();if(d.byteLength>=a.size)return{compressionType:0,data:b};b=C3Peer.COMPRESSION_TYPES.indexOf(c);if(0>b)throw Error("invalid compression type");return{compressionType:b,data:d}}async Send(b,a,c=0){this._domHandler.StatAddOutboundDecompressedBandwidthCount(a);
const d=this._PrepareSend(b,a,c);a=d;"o"===b&&(a=this._sendThrottle.Add(()=>d));(a=await a)&&this._NetworkSend(b,a)}async _PrepareSend(b,a,c=0){var d="string"===typeof a;const {compressionType:e,data:f}=await this._MaybeCompress(a);a=f;f instanceof ArrayBuffer&&(0!==e&&(c|=e<<4,d&&(c|=C3Peer.FLAG_STRING_DATA)),a=new ArrayBuffer(f.byteLength+8),d=new DataView(a),d.setUint32(0,C3Peer.MAGIC_NUMBER),d.setUint32(4,c),(new Uint8Array(a,8)).set(new Uint8Array(f)));this._domHandler.StatIncOutboundCount();
this._domHandler.StatAddOutboundBandwidthCount(a);c=this._domHandler.GetSimulatedPacketLoss();d=this._domHandler.GetSimulatedLatency();const g=this._domHandler.GetSimulatedPdv();if(0<c&&"u"===b&&Math.random()<c)return null;if(0!==d||0!==g){let h=1;"u"!==b&&Math.random()<c&&(h=3);await Wait((d+Math.random()*g)*h)}return a}_NetworkSend(b,a){try{"o"===b?this._isOOpen&&this._dco&&this._dco.send(a):"r"===b?this._isROpen&&this._dcr&&this._dcr.send(a):"u"===b&&this._isUOpen&&this._dcu&&this._dcu.send(a)}catch(c){this._wasRemoved||
(this._domHandler.IsHost()?"o"===b||"r"===b?("string"===typeof a?(console.error("Error sending "+a.length+"-char string on '"+b+"' to '"+this._alias+"', host kicking: ",c),console.log("String that failed to send from previous error was: "+a)):console.error("Error sending "+(a.length||a.byteLength)+"-byte binary on '"+b+"' to '"+this._alias+"', host kicking: ",c),this.Remove("network error")):(this._errorCount++,10<=this._errorCount&&("string"===typeof a?(console.error("Too many errors ("+this._errorCount+
") sending data on '"+b+"' to '"+this._alias+"', kicking; last error was for sending "+a.length+"-char string: ",c),console.log("String that failed to send from previous error was: "+a)):console.error("Too many errors ("+this._errorCount+") sending data on '"+b+"' to '"+this._alias+"', kicking; last error was for sending "+(a.length||a.byteLength)+"-byte binary: ",c),this.Remove("network error"))):console.error("Error sending data on '"+b+"': ",c))}}SendPing(b,a){this._wasRemoved||(!a&&!this.IsOpen()&&
this._pc&&25E3<b-this._connectTime?(console.warn("Timed out '"+this._alias+"', could not establish connection after 25sec"),this.Remove("timeout")):!a&&this.IsOpen()&&2E4<b-this._lastHeardFrom?(console.warn("Timed out '"+this._alias+"', not heard from for 20sec"),this.Remove("timeout")):(this._lastPingSent=b,this._awaitingPong=!0,this._lastSentPingId++,this.Send("u","ping:"+this._lastSentPingId)))}SendPong(b){b="pong:"+b.substr(5);this._domHandler.IsHost()&&(b=b+"/"+Math.round(performance.now()).toString());
this.Send("u",b)}_OnPong(b){if(this._awaitingPong){var a=b.indexOf(":");if(-1<a){if(parseFloat(b.substr(a+1))===this._lastSentPingId){a=performance.now();this._awaitingPong=!1;var c=(a-this._lastPingSent)/2;this._lastPingTimes.push(c);10<this._lastPingTimes.length&&this._lastPingTimes.shift();tempArray.push(...this._lastPingTimes);tempArray.sort((g,h)=>g-h);this._pdv=tempArray[tempArray.length-1]-tempArray[0];var d=0,e=tempArray.length;4<=tempArray.length&&6>=tempArray.length?(++d,--e):6<tempArray.length&&
(d+=2,e-=2);var f=0;for(let g=d;g<e;++g)f+=tempArray[g];this._latency=f/(e-d);tempArray.length=0;this._domHandler.IsHost()||(d=b.indexOf("/"),-1<d?(b=parseFloat(b.substr(d+1)),isFinite(b)?this._domHandler.AddHostTime(b,a,c,this._latency):console.warn("Invalid host time from pong response")):console.warn("Cannot parse off host time from pong response"))}}else console.warn("Cannot parse off ping ID from pong")}}async _OnNetworkMessage(b,a){const c=this._PrepareReceive(b,a.data);a=c;"o"===b&&(a=this._receiveThrottle.Add(()=>
c));(a=await a)&&this._HandleReceivedMessage(b,a)}async _PrepareReceive(b,a){this._domHandler.StatIncInboundCount();this._domHandler.StatAddInboundBandwidthCount(a);const c=this._domHandler.GetSimulatedPacketLoss(),d=this._domHandler.GetSimulatedLatency(),e=this._domHandler.GetSimulatedPdv();if(0<c&&"u"===b&&Math.random()<c)return null;if(0!==d||0!==e){let f=1;"u"!==b&&Math.random()<c&&(f=3);await Wait(d*f+Math.random()*e*f)}return a instanceof ArrayBuffer?await this._ReadBinaryHeaderAndMaybeDecompress(a):
a}async _ReadBinaryHeaderAndMaybeDecompress(b){if(8>b.byteLength)return console.warn(`Rejected binary message as too small (only ${b.byteLength} bytes)`),null;var a=new DataView(b),c=a.getUint32(0);a=a.getUint32(4);if(c!==C3Peer.MAGIC_NUMBER)return console.warn(`Rejected binary message with invalid magic number (0x${c.toString(16)})`),null;c=(a&C3Peer.FLAG_COMPRESSION_MASK)>>4;if(0===c)return{data:b,offset:8,flags:a};if(c>=C3Peer.COMPRESSION_TYPES.length)throw Error("invalid compression type");c=
C3Peer.COMPRESSION_TYPES[c];b=new Blob([new Uint8Array(b,8)]);c=new DecompressionStream(c);b=b.stream().pipeThrough(c);b=await (new Response(b)).arrayBuffer();return 0===(a&C3Peer.FLAG_STRING_DATA)?{data:b,offset:0,flags:a}:(new TextDecoder).decode(b)}_HandleReceivedMessage(b,a){if(!this._wasRemoved)if(this._lastHeardFrom=performance.now(),"string"===typeof a){if(this._domHandler.StatAddInboundDecompressedBandwidthCount(a),!(""===a.trim()||4>a.length)){var c=a.substr(0,4);if("ping"===c)this.SendPong(a);
else if("pong"===c)this._OnPong(a);else{try{var d=JSON.parse(a)}catch(e){this._domHandler._OnPeerError(this,e);this._domHandler.IsHost()?(console.error("Error parsing message as JSON for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error parsing message as JSON for peer '"+this._id+"': ",e);console.log("String that failed to parse from previous error: "+a);return}if(d)try{d.c&&"m"!==d.c?this._OnControlMessage(d):this._domHandler._OnPeerMessage(this,d,b)}catch(e){this._domHandler._OnPeerError(this,
e),this._domHandler.IsHost()?(console.error("Error handling message for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error handling message for peer '"+this._id+"': ",e)}}}}else{this._domHandler.StatAddInboundDecompressedBandwidthCount(a.data);!this._hasConfirmed&&this._domHandler.IsHost()&&"u"===b&&(this._hasConfirmed=!0,this._domHandler.SignallingConfirmPeer(this._id));try{this._OnBinaryMessage(a.data,a.offset,a.flags,b)}catch(e){this._domHandler._OnPeerError(this,
e),this._domHandler.IsHost()?(console.error("Error handling binary update for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error handling binary update for peer '"+this._id+"': ",e)}}}_OnControlMessage(b){switch(b.c){case "disconnect":b.k&&this._domHandler.OnWasKicked();var a=!this._domHandler.IsHost()&&!this.IsHost();this.Remove(b.r);a&&this._domHandler.SignallingLeaveRoom();break;case "hi":this._domHandler.IsHost()||(this._domHandler.GetHostPeer()._SetNid(b.hn),
this._domHandler.GetSelfPeer()._SetNid(b.n),this._domHandler.SetClientDelay(b.d),this._domHandler.SetPeerUpdateRateSec(b.u),this._domHandler.MapObjectNids(b.objs),this._domHandler.MapClientValues(b.cvs),b.hasOwnProperty("comp")&&this._DetermineSupportedCompressionFormats(b.comp));break;case "comp":this._DetermineSupportedCompressionFormats(b.comp);break;case "j":this._domHandler.IsHost()||(a=new C3Peer(this._domHandler,b.i,b.a),a._SetNid(b.n),this._domHandler._OnPeerOpen(a));break;case "l":!this._domHandler.IsHost()&&
(a=this._domHandler.GetPeerById(b.i))&&(a.IsSelf()||this._domHandler._OnPeerClose(a,b.r),a.Remove(b.r));break;default:console.error("Unknown control message from peer '"+this._id+"': "+b.c),this._domHandler._OnPeerError(this,"unknown control message '"+b.c+"'")}}_OnBinaryMessage(b,a,c,d){0===(c&C3Peer.FLAG_SCRIPT_DATA)?(b=new DataView(b,a),this._domHandler.IsHost()?this._OnHostUpdate(b,c):this._OnPeerUpdate(b,c)):this._domHandler._OnPeerBinaryMessage(this,0===a?b:b.slice(a),d)}_OnHostUpdate(b,a){a=
0;let c=b.getFloat64(a);a+=8;c+=this._latency;if(!(3E3<=Math.abs(c-performance.now()))){var d=b.getUint8(a);a+=1;var e=[],f=this._domHandler.GetClientValues();for(let h=0;h<d;++h)if(h>=f.length)e.push(0);else{var g=f[h];switch(g.GetPrecision()){case 0:g=b.getFloat64(a);a+=8;break;case 1:g=b.getFloat32(a);a+=4;break;case 2:g=g.MaybeUnpack(b.getInt16(a));a+=2;break;case 3:g=g.MaybeUnpack(b.getUint8(a));a+=1;break;default:g=b.getFloat32(a),a+=4}e.push(g)}this._AddClientUpdate(c,e)}}_AddClientUpdate(b,
a){for(let c=0,d=this._clientStateUpdates.length;c<d;++c){const e=this._clientStateUpdates[c];if(e.timestamp===b)return;if(e.timestamp>b){this._clientStateUpdates.splice(c,0,new C3NetUpdate$jscomp$1(b,a));return}}this._clientStateUpdates.push(new C3NetUpdate$jscomp$1(b,a))}Tick(b){if(0!==this._clientStateUpdates.length){for(;2<this._clientStateUpdates.length&&this._clientStateUpdates[0]!==this._priorUpdate2&&this._clientStateUpdates[0]!==this._priorUpdate&&this._clientStateUpdates[0]!==this._nextUpdate;)this._clientStateUpdates.shift();
if(!(this._nextUpdate&&this._nextUpdate.timestamp>b&&this._priorUpdate&&this._priorUpdate.timestamp<b)){this._nextUpdate=null;for(let a=0,c=this._clientStateUpdates.length;a<c;++a){const d=this._clientStateUpdates[a];if(d.timestamp<=b){if(!this._priorUpdate||d.timestamp>this._priorUpdate.timestamp)this._priorUpdate2=this._priorUpdate,this._priorUpdate=d}else{this._nextUpdate=d;break}}}}}_OnPeerUpdate(b,a){0===(a&C3Peer.FLAG_HOST_UPDATE_TYPE)?this._HandlePeerUpdate(b):this._HandlePeerEvents(b)}_HandlePeerUpdate(b){let a=
0;const c=b.getFloat64(a);a+=8;const d=b.getUint16(a);a+=2;for(let h=0;h<d;++h){var e=b.getUint16(a);a+=2;var f=b.getUint8(a);a+=1;let k=null,m=0;const l=this._domHandler.GetRegisteredObjectByNid(e);l?(k=l.GetNetValues(),m=k.length,1===f&&l._SetHasOverriddenNids(!0)):console.warn("Don't know which object corresponds to NID "+e);e=b.getUint16(a);a+=2;f=b.getUint16(a);a+=2;for(let q=0;q<e;++q){const t=b.getUint16(a);a+=2;if(l){const r=[];let n=a;for(let p=0;p<m;++p){var g=k[p];switch(g.GetPrecision()){case 0:g=
b.getFloat64(n);n+=8;break;case 1:g=b.getFloat32(n);n+=4;break;case 2:g=g.MaybeUnpack(b.getInt16(n));n+=2;break;case 3:g=g.MaybeUnpack(b.getUint8(n));n+=1;break;default:g=b.getFloat32(n),n+=4}r.push(g)}l.AddUpdate(c,t,r)}a+=f}}}_HandlePeerEvents(b){let a=0;const c=b.getFloat64(a);a+=8;const d=b.getUint16(a);a+=2;for(let f=0;f<d;++f){var e=b.getUint16(a);a+=2;const g=this._domHandler.GetRegisteredObjectByNid(e);g||console.warn("Don't know which object corresponds to NID "+e);e=b.getUint16(a);a+=2;
for(let h=0;h<e;++h){const k=b.getUint16(a);a+=2;g&&!g.HasOverriddenNids()&&(this._domHandler._OnInstanceDestroyed(g,k,c),g.RemoveObjectNid(k))}}}Remove(b,a){if(!this._wasRemoved){this._wasRemoved=!0;this._MaybeFireClose(b);this.Send("o",JSON.stringify({c:"disconnect",r:b,k:!!a}));var c=this._dco,d=this._dcr,e=this._dcu,f=this._pc;setTimeout(()=>{CloseIgnoreException(c);CloseIgnoreException(d);CloseIgnoreException(e);CloseIgnoreException(f)},0);this._pc=this._dcu=this._dcr=this._dco=null;this._isUOpen=
this._isROpen=this._isOOpen=!1;this._domHandler._RemovePeer(this)}}HasClientState(b){return this._domHandler.HasClientValueTag(b)}GetClientState(b){b=this._domHandler.GetClientValueByTag(b);if(!b)return 0;b=b.GetIndex();if(0===this._clientStateUpdates.length)return 0;const a=this._clientStateUpdates[this._clientStateUpdates.length-1].data;return 0>b||b>=a.length?0:a[b]}GetInterpClientState(b){b=b.GetIndex();if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate){var a=
this._nextUpdate.data;return 0>b||b>=a.length?0:a[b]}var c=this._domHandler.GetSimulationTime();let d,e;if(!this._nextUpdate&&this._priorUpdate){if(this._priorUpdate2){var f=this._priorUpdate2.timestamp;a=this._priorUpdate2.data[b];d=this._priorUpdate.timestamp;e=this._priorUpdate.data[b];c>this._priorUpdate.timestamp+250&&(c=this._priorUpdate.timestamp+250);f=unlerp$jscomp$1(f,d,c);return C3NetValue$jscomp$1.InterpNetValue(this._domHandler.GetClientValues()[b].GetInterp(),a,e,f,!0)}a=this._priorUpdate.data;
return 0>b||b>=a.length?0:a[b]}f=this._priorUpdate.timestamp;a=this._priorUpdate.data[b];d=this._nextUpdate.timestamp;e=this._nextUpdate.data[b];f=unlerp$jscomp$1(f,d,c);return C3NetValue$jscomp$1.InterpNetValue(this._domHandler.GetClientValues()[b].GetInterp(),a,e,f,!1)}}C3Peer.MAGIC_NUMBER=1664314736;C3Peer.FLAG_HOST_UPDATE_TYPE=1;C3Peer.FLAG_STRING_DATA=2;C3Peer.FLAG_SCRIPT_DATA=4;C3Peer.FLAG_COMPRESSION_MASK=240;C3Peer.COMPRESSION_TYPES=["none","deflate","gzip"];self.C3Peer=C3Peer;"use strict";
const C3NetValue$jscomp$2=self.C3NetValue,C3Peer$jscomp$1=self.C3Peer,RTCPeerConnection$jscomp$2=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection,RTCSessionDescription$jscomp$1=window.RTCSessionDescription||window.webkitRTCSessionDescription||window.mozRTCSessionDescription||window.msRTCSessionDescription,RTCIceCandidate$jscomp$1=window.RTCIceCandidate||window.webkitRTCIceCandidate||window.mozRTCIceCandidate||window.msRTCIceCandidate,
RTCDataChannel$jscomp$1=window.RTCDataChannel||window.webkitRTCDataChannel||window.mozRTCDataChannel||window.msRTCDataChannel,DEFAULT_ICE_SERVER_LIST=[{urls:"stun:stun.l.google.com:19302"}];function SupportsCompressionStreamFormat(b){if("undefined"===typeof CompressionStream||"function"!==typeof Blob.prototype.stream)return!1;try{return new CompressionStream(b),!0}catch(a){return!1}}
function GetDataSize(b){if("number"===typeof b.byteLength)return b.byteLength;if("number"===typeof b.length)return b.length;console.warn("[Construct] Multiplayer: don't know how to measure size of data: ",b);return 0}const localSupportedCompressionFormats=[];SupportsCompressionStreamFormat("deflate")&&localSupportedCompressionFormats.push("deflate");SupportsCompressionStreamFormat("gzip")&&localSupportedCompressionFormats.push("gzip");let isRemovingAllPeers=!1;const tempArray$jscomp$1=[];
self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMHandler{constructor(b){super(b,"multiplayer");this._iceServers=[];this._sigWs=null;this._isSignallingLoggedIn=this._isSignallingConnected=!1;this._sigservInfo={protocolrev:0,version:0,name:"",operator:"",motd:""};this._room=this._gameInstance=this._game=this._myAlias=this._myId="";this._allPeers=[];this._peersById=new Map;this._nextPeerNid=0;this._usedPeerNids=new Set;this._hostPeer=this._selfPeer=null;this._clientDelay=80;this._peerUpdateRateSec=
this._hostUpdateRateSec=30;this._lastUpdateTime=0;this._stats={lastSecondTime:0,outboundPerSec:0,outboundCount:0,outboundBandwidthPerSec:0,outboundDecompressedBandwidthPerSec:0,outboundBandwidthCount:0,outboundDecompressedBandwidthCount:0,inboundPerSec:0,inboundCount:0,inboundBandwidthPerSec:0,inboundDecompressedBandwidthPerSec:0,inboundBandwidthCount:0,inboundDecompressedBandwidthCount:0};this._dataBuffer=new ArrayBuffer(262144);this._dataView=new DataView(this._dataBuffer);this._allRegisteredObjects=
[];this._nextObjectNid=1;this._registeredObjectsByNid=new Map;this._registeredObjectsByRoId=new Map;this._simPacketLoss=this._simPdv=this._simLatency=0;this._lastTimeDiffs=[];this._hostTimeDiff=this._targetHostTimeDiff=0;this._simDelay=this._targetSimDelay=this._clientDelay;this._allClientValues=[];this._clientValuesByTag=new Map;this._receivedClientValues=!1;this._signallingPromises={connect:{resolve:null,reject:null},login:{resolve:null,reject:null},joinRoom:{resolve:null,reject:null},leaveRoom:{resolve:null,
reject:null},listGameInstances:{resolve:null,reject:null},listRooms:{resolve:null,reject:null}};this._MergeICEServerList(DEFAULT_ICE_SERVER_LIST);setInterval(()=>this._DoPings(),2E3);window.addEventListener("unload",()=>this.RemoveAllPeers("quit"));this.AddRuntimeMessageHandler("get-supported",()=>this._OnGetSupported());this.AddRuntimeMessageHandler("add-ice-servers",a=>this._MergeICEServerList(a.list));this.AddRuntimeMessageHandler("simulate-latency",a=>this.SetLatencySimulation(a.latency,a.pdv,
a.loss));this.AddRuntimeMessageHandler("set-bandwidth-profile",a=>this.SetBandwidthSettings(a.updateRate,a.delay));this.AddRuntimeMessageHandler("tick",a=>this.Tick(a));this.AddRuntimeMessageHandler("alert",a=>this.Alert(a));this.AddRuntimeMessageHandler("signalling-connect",a=>this.SignallingConnect(a.url));this.AddRuntimeMessageHandler("signalling-disconnect",()=>this.SignallingDisconnect());this.AddRuntimeMessageHandler("signalling-login",a=>this.SignallingLogin(a.alias));this.AddRuntimeMessageHandler("signalling-join-room",
a=>this.SignallingJoinGameRoom(a.game,a.instance,a.room,a.maxClients));this.AddRuntimeMessageHandler("signalling-auto-join-room",a=>this.SignallingAutoJoinGameRoom(a.game,a.instance,a.room,a.maxClients,a.lock));this.AddRuntimeMessageHandler("signalling-leave-room",()=>this.SignallingLeaveRoom());this.AddRuntimeMessageHandler("signalling-list-game-instances",a=>this.SignallingRequestGameInstanceList(a.game));this.AddRuntimeMessageHandler("signalling-list-rooms",a=>this.SignallingRequestRoomList(a.game,
a.instance,a.which));this.AddRuntimeMessageHandler("disconnect-room",()=>this.DisconnectRoom(!0));this.AddRuntimeMessageHandler("peer-send-message",a=>this.OnPeerSendMessage(a));this.AddRuntimeMessageHandler("host-broadcast",a=>this.OnHostBroadcast(a));this.AddRuntimeMessageHandler("kick-peer",a=>this.OnKickPeer(a));this.AddRuntimeMessageHandler("sync-object",a=>this.OnSyncObject(a));this.AddRuntimeMessageHandler("sync-inst-var",a=>this.OnSyncInstVar(a));this.AddRuntimeMessageHandler("associate-object",
a=>this.OnAssociateObject(a));this.AddRuntimeMessageHandler("remove-object-id",a=>this.RemoveObjectId(a.uid));this.AddRuntimeMessageHandler("remove-net-insts",a=>this.OnRemoveNetInsts(a));this.AddRuntimeMessageHandler("remove-object-nid",a=>this.OnRemoveObjectNid(a));this.AddRuntimeMessageHandler("set-client-state",a=>this.SetClientState(a.tag,a.value));this.AddRuntimeMessageHandler("add-client-input-value",a=>this.AddClientInputValue(a.tag,a.precision,a.interp))}_GetErrorMessage(b){return b?"string"===
typeof b?b:"string"===typeof b.message?b.message:"string"===typeof b.details?b.details:"string"===typeof b.data?b.data:"string"===typeof b.type?b.type:"unknown error":"unknown error"}IsConnected(){return this._isSignallingConnected}IsLoggedIn(){return this.IsConnected()&&this._isSignallingLoggedIn}IsInRoom(){return!!this._room}IsHost(){return this.IsInRoom()&&this._selfPeer&&this._hostPeer===this._selfPeer}GetMyId(){return this._myId}GetMyAlias(){return this._myAlias}GetCurrentGame(){return this._game}GetCurrentGameInstance(){return this._gameInstance}GetCurrentRoom(){return this._room}GetHostId(){return this._hostPeer?
this._hostPeer.GetId():""}GetHostAlias(){return this._hostPeer?this._hostPeer.GetAlias():""}GetHostPeer(){return this._hostPeer}GetSelfPeer(){return this._selfPeer}SetLatencySimulation(b,a,c){this._simLatency=Math.max(b,0);this._simPdv=Math.max(a,0);this._simPacketLoss=Math.max(c,0)}GetSimulatedPacketLoss(){return this._simPacketLoss}GetSimulatedLatency(){return this._simLatency}GetSimulatedPdv(){return this._simPdv}_OnGetSupported(){return{isSupported:!(!RTCPeerConnection$jscomp$2||!RTCDataChannel$jscomp$1)}}_CreateSignallingPromise(b){b.reject&&
b.reject("overlapping signalling operation");return new Promise((a,c)=>{b.resolve=a;b.reject=c})}_ResolveSignallingPromise(b,a){b.resolve&&b.resolve(a);b.resolve=null;b.reject=null}_RejectSignallingPromises(b){for(const a of Object.values(this._signallingPromises))a.reject&&a.reject(b),a.resolve=null,a.reject=null}SignallingConnect(b){if(this._sigWs||this._isSignallingConnected)return Promise.resolve();const a=this._CreateSignallingPromise(this._signallingPromises.connect);try{this._sigWs=new WebSocket(b,
"c2multiplayer")}catch(c){return this._sigWs=null,this._OnSignallingError(c),a}this._sigWs.onopen=()=>{-1===this._sigWs.protocol.indexOf("c2multiplayer")?(this._OnSignallingError("server does not support 'c2multiplayer' protocol"),this._sigWs.close(1002,"'c2multiplayer' protocol required"),this._sigWs=null,this._isSignallingConnected=!1):this._isSignallingConnected=!0};this._sigWs.onclose=c=>{this._OnSignallingClose();this._isSignallingLoggedIn=this._isSignallingConnected=!1;this._sigWs=null};this._sigWs.onerror=
c=>{console.error("Signalling server error: ",c);this._OnSignallingError(c)};this._sigWs.onmessage=c=>{this._OnSignallingMessage(c)};return a}SignallingDisconnect(){this._sigWs&&this._isSignallingConnected&&(this._sigWs.close(),this._sigWs=null,this._isSignallingConnected=!1)}_OnSignallingMessage(b){let a;try{a=JSON.parse(b.data)}catch(c){this._OnSignallingError(c);return}switch(a.message){case "welcome":this._OnSignallingReceiveWelcome(a);break;case "login-ok":this._OnSignallingReceiveLoginOK(a);
break;case "join-ok":this._OnSignallingReceiveJoinOK(a);break;case "leave-ok":this._OnSignallingReceiveLeaveOK(a);break;case "kicked":this._OnSignallingReceiveKicked(a);break;case "peer-joined":this._OnSignallingReceivePeerJoined(a);break;case "peer-quit":this._OnSignallingReceivePeerQuit(a);break;case "icecandidate":this._OnSignallingReceiveIceCandidate(a);break;case "offer":this._OnSignallingReceiveOffer(a);break;case "answer":this._OnSignallingReceiveAnswer(a);break;case "instance-list":this._OnSignallingReceiveInstanceList(a);
break;case "room-list":this._OnSignallingReceiveRoomList(a);break;case "error":this._OnSignallingError(a.details);break;default:this._OnSignallingError("received unknown signalling message")}}HasICEServerUrl(b){for(const a of this._iceServers)if(a.urls===b.urls)return!0;return!1}_MergeICEServerList(b){if(b)for(let a of b)"string"===typeof a&&(a={urls:a}),this.HasICEServerUrl(a)||(a.hasOwnProperty("url")||(a.url=a.urls),this._iceServers.push(a))}GetICEServerList(){return this._iceServers}_OnSignallingError(b){this.PostToRuntime("signalling-error",
{message:this._GetErrorMessage(b)});this._RejectSignallingPromises(b)}_OnSignallingClose(){this.PostToRuntime("signalling-close")}_OnSignallingReceiveWelcome(b){if(1>b.protocolrev||1<b.protocolrev)this._OnSignallingError("signalling server protocol revision not supported"),this.SignallingDisconnect();else{this._myId=b.clientid;this._room="";var a=this._sigservInfo;a.protocolrev=b.protocolrev;a.version=b.version;a.name=b.name;a.operator=b.operator;a.motd=b.motd;this._MergeICEServerList(b.ice_servers);
this.PostToRuntime("signalling-welcome",{myid:this._myId,sigservinfo:{protocolrev:a.protocolrev,version:a.version,name:a.name,operator:a.operator,motd:a.motd}});this._ResolveSignallingPromise(this._signallingPromises.connect)}}_OnSignallingReceiveLoginOK(b){this._myAlias=b.alias;this._isSignallingLoggedIn=!0;this.PostToRuntime("signalling-login-ok",{myalias:this._myAlias});this._ResolveSignallingPromise(this._signallingPromises.login)}GetNextObjectNid(){return this._nextObjectNid++}AllocatePeerNid(){if(this.IsHost()){do this._nextPeerNid++,
65535<this._nextPeerNid&&(this._nextPeerNid=0);while(this._usedPeerNids.has(this._nextPeerNid));var b=this._nextPeerNid;this._usedPeerNids.add(b);return b}}FreePeerNid(b){this.IsHost()&&this._usedPeerNids.delete(b)}_OnSignallingReceiveJoinOK(b){this.RemoveAllPeers("disconnect");this._game=b.game;this._gameInstance=b.instance;this._room=b.room;this._selfPeer=new C3Peer$jscomp$1(this,this._myId,this._myAlias);b.host?(this._hostPeer=this._selfPeer,this._nextPeerNid=0,this._usedPeerNids.clear(),this._hostPeer._SetNid(this.AllocatePeerNid())):
(this._hostTimeDiff=this._targetHostTimeDiff=this._lastTimeDiffs.length=0,this._clientDelay=80,this._peerUpdateRateSec=this._hostUpdateRateSec=30,this._simDelay=this._targetSimDelay=this._clientDelay,this._hostPeer=new C3Peer$jscomp$1(this,b.hostid,b.hostalias),this._hostPeer.Connect());this.PostToRuntime("signalling-join-ok",{isHost:!!b.host,hostId:this._hostPeer.GetId(),hostAlias:this._hostPeer.GetAlias(),game:this._game,gameInstance:this._gameInstance,room:this._room});this._ResolveSignallingPromise(this._signallingPromises.joinRoom)}_OnSignallingReceiveLeaveOK(b){this._room=
"";this.PostToRuntime("signalling-leave-ok");this._ResolveSignallingPromise(this._signallingPromises.leaveRoom)}_OnSignallingReceiveKicked(b){"host-left"===b.reason?this.SignallingDisconnect():(this.DisconnectRoom(),this._room="",this.PostToRuntime("signalling-kicked"))}_OnSignallingReceivePeerJoined(b){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){var a=this._peersById.get(b.peerid);a&&a.Remove("rejoin");(new C3Peer$jscomp$1(this,b.peerid,b.peeralias)).Connect()}}_OnSignallingReceivePeerQuit(b){if(this._isSignallingLoggedIn&&
this._room&&this.IsHost()){var a=this._peersById.get(b.id);a&&a.Remove(b.reason)}}_OnSignallingReceiveIceCandidate(b){if(this._isSignallingLoggedIn&&this._room){var a=this._peersById.get(b.from);a&&a._AddICECandidate(new RTCIceCandidate$jscomp$1(b.icecandidate))}}_OnSignallingReceiveOffer(b){if(this._isSignallingLoggedIn&&this._room&&!this.IsHost()&&this._selfPeer&&this._hostPeer&&this._hostPeer.HasPeerConnection()&&b.from===this._hostPeer.GetId()){var a=this._hostPeer.GetPeerConnection();a.setRemoteDescription(new RTCSessionDescription$jscomp$1(b.offer)).then(()=>
{a.createAnswer().then(c=>{a.setLocalDescription(c);this.SignallingSend({message:"answer",toclientid:this._hostPeer.GetId(),answer:c})}).catch(c=>{console.error("Peer error creating answer: ",c);this._OnPeerError(this._selfPeer,"could not create answer to host offer")})}).catch(c=>{console.error("Peer error setting remote description: ",c);this._OnPeerError(this._selfPeer,"could not set remote description")})}}_OnSignallingReceiveAnswer(b){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){var a=
this._peersById.get(b.from);a&&a.GetPeerConnection().setRemoteDescription(new RTCSessionDescription$jscomp$1(b.answer)).catch(c=>{console.error("Host error setting remote description: ",c)})}}_OnSignallingReceiveInstanceList(b){this.PostToRuntime("signalling-instance-list",{list:b.list});this._ResolveSignallingPromise(this._signallingPromises.listGameInstances)}_OnSignallingReceiveRoomList(b){this.PostToRuntime("signalling-room-list",{list:b.list});this._ResolveSignallingPromise(this._signallingPromises.listRooms)}SignallingSend(b){this._sigWs&&
this._isSignallingConnected&&this._sigWs.send(JSON.stringify(b))}SignallingLogin(b){if(!this._isSignallingLoggedIn){var a=this._CreateSignallingPromise(this._signallingPromises.login);this.SignallingSend({message:"login",protocolrev:1,datachannelrev:2,compressionformats:this.GetLocalSupportedCompressionFormats(),alias:b});return a}}SignallingJoinGameRoom(b,a,c,d){if(this._isSignallingLoggedIn&&!this._room){var e=this._CreateSignallingPromise(this._signallingPromises.joinRoom);this.SignallingSend({message:"join",
game:b,instance:a,room:c,max_clients:d});return e}}SignallingAutoJoinGameRoom(b,a,c,d,e){if(this._isSignallingLoggedIn&&!this._room){var f=this._CreateSignallingPromise(this._signallingPromises.joinRoom);this.SignallingSend({message:"auto-join",game:b,instance:a,room:c,max_clients:d,lock_when_full:e});return f}}SignallingLeaveRoom(){if(this._isSignallingLoggedIn){var b=this._CreateSignallingPromise(this._signallingPromises.leaveRoom);this.SignallingSend({message:"leave"});return b}}SignallingConfirmPeer(b){this._isSignallingLoggedIn&&
this.IsHost()&&this.SignallingSend({message:"confirm-peer",id:b})}SignallingRequestGameInstanceList(b){if(this._sigWs&&this._isSignallingConnected){var a=this._CreateSignallingPromise(this._signallingPromises.listGameInstances);this.SignallingSend({message:"list-instances",game:b});return a}}SignallingRequestRoomList(b,a,c){if(this._sigWs&&this._isSignallingConnected){var d=this._CreateSignallingPromise(this._signallingPromises.listRooms);this.SignallingSend({message:"list-rooms",game:b,instance:a,
which:c});return d}}DisconnectRoom(b){this._hostTimeDiff=this._targetHostTimeDiff=this._lastTimeDiffs.length=0;this.RemoveAllPeers("disconnect");for(const a of this._allRegisteredObjects)a.ClearAllNetInstances();b&&this.SignallingLeaveRoom()}_AddPeer(b){this._allPeers.push(b);this._peersById.set(b.GetId(),b);this.PostToRuntime("add-peer",{id:b.GetId(),alias:b.GetAlias()})}_RemovePeer(b){this.PostToRuntime("remove-peer",{id:b.GetId()});this.IsHost()&&this.FreePeerNid(b.GetNid());const a=this._allPeers.indexOf(b);
-1<a&&this._allPeers.splice(a,1);this._peersById.delete(b.GetId());this._hostPeer===b&&(this._hostPeer=null,this.RemoveAllPeers("host quit"));this._selfPeer===b&&(this._selfPeer=null,this._room="",this.RemoveAllPeers("disconnect"))}RemoveAllPeers(b){if(!isRemovingAllPeers){for(isRemovingAllPeers=!0;this._allPeers.length;)this._allPeers[0].Remove(b);isRemovingAllPeers=!1}}GetPeerById(b){return this._peersById.get(b)||null}GetAliasFromId(b){return(b=this._peersById.get(b))?b.GetAlias():""}GetPeerByNid(b){for(const a of this._allPeers)if(a.GetNid()===
b)return a;return null}OnHostBroadcast(b){var a=b.fromId;const c=b.tag,d=b.message,e=b.transmissionMode;b=b.contentMode;const f=this.GetPeerById(a);"s"===b&&d instanceof ArrayBuffer?this.HostBroadcast(e,d,C3Peer$jscomp$1.FLAG_SCRIPT_DATA,f):(a={c:"m",cm:b,f:a,m:d},"e"===b&&(a.t=c),this.HostBroadcast(e,JSON.stringify(a),0,f))}HostBroadcast(b,a,c=0,d=null){if(this.IsHost()){var e=this._allPeers.slice(0);for(const f of e)f&&f!==this._selfPeer&&f!==d&&f.Send(b,a,c)}}_DoPings(){const b=performance.now();
if(this.IsHost()){tempArray$jscomp$1.push(...this._allPeers);for(const a of tempArray$jscomp$1)a&&a!==this._selfPeer&&a.SendPing(b,!1);tempArray$jscomp$1.length=0}else this._hostPeer&&this._hostPeer.SendPing(b,!1)}AddRegisteredObject(b){this._allRegisteredObjects.push(b);this._registeredObjectsByRoId.set(b.GetRoId(),b);this._registeredObjectsByNid.set(b.GetNid(),b)}GetRegisteredObjectsMap(){const b={};for(const [a,c]of this._registeredObjectsByNid.entries())b[c.GetSid()]={nid:a,nvs:c.GetNetValuesJson()};
return b}MapObjectNids(b){this._registeredObjectsByNid.clear();for(const a of this._allRegisteredObjects)if(b.hasOwnProperty(a.GetSid().toString())){const c=b[a.GetSid().toString()];a._SetNid(c.nid);this._registeredObjectsByNid.set(c.nid,a);a.SetNetValuesFrom(c.nvs)}else console.warn("Could not map object SID '"+a.GetSid()+"' - host did not send NID for it"),a._SetNid(-1)}GetRegisteredObjectByNid(b){return this._registeredObjectsByNid.get(b)||null}Tick(b){if(!this.IsInRoom())return null;b=b.dt;const a=
performance.now();var c=this.IsHost()?this._hostUpdateRateSec:this._peerUpdateRateSec;a-this._lastUpdateTime>=1E3/c-5&&(this.SendUpdate(a),this._lastUpdateTime=a);c=this._stats;1E3<=a-c.lastSecondTime&&(c.outboundPerSec=c.outboundCount,c.outboundBandwidthPerSec=c.outboundBandwidthCount,c.outboundDecompressedBandwidthPerSec=c.outboundDecompressedBandwidthCount,c.inboundPerSec=c.inboundCount,c.inboundBandwidthPerSec=c.inboundBandwidthCount,c.inboundDecompressedBandwidthPerSec=c.inboundDecompressedBandwidthCount,
c.outboundCount=0,c.outboundBandwidthCount=0,c.outboundDecompressedBandwidthCount=0,c.inboundCount=0,c.inboundBandwidthCount=0,c.inboundDecompressedBandwidthCount=0,c.lastSecondTime+=1E3,500<a-c.lastSecondTime&&(c.lastSecondTime=a),this.PostToRuntime("stats",{stats:{outboundPerSec:c.outboundPerSec,outboundBandwidthPerSec:c.outboundBandwidthPerSec,outboundDecompressedBandwidthPerSec:c.outboundDecompressedBandwidthPerSec,inboundPerSec:c.inboundPerSec,inboundBandwidthPerSec:c.inboundBandwidthPerSec,
inboundDecompressedBandwidthPerSec:c.inboundDecompressedBandwidthPerSec}}));this.IsHost()||(this._hostTimeDiff<this._targetHostTimeDiff?(this._hostTimeDiff+=10*b,this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)):this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff-=10*b,this._hostTimeDiff<this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)),this._simDelay<this._targetSimDelay?(this._simDelay+=30*b,this._simDelay>this._targetSimDelay&&
(this._simDelay=this._targetSimDelay)):this._simDelay>this._targetSimDelay&&(this._simDelay-=30*b,this._simDelay<this._targetSimDelay&&(this._simDelay=this._targetSimDelay)));b=this.GetSimulationTime();for(const d of this._allPeers)d.Tick(b);for(const d of this._allRegisteredObjects)d.Tick();return{simulationTime:this.GetSimulationTime(),hostInputArrivalTime:this.GetHostInputArrivalTime(),clientDelay:this._clientDelay,peerData:this._GetPeerRuntimeData(),roData:this._GetRegisteredObjectRuntimeData(),
isReadyForInput:this.IsReadyForInput()}}_GetPeerRuntimeData(){const b={};for(const a of this._allPeers){const c={};for(const d of this._allClientValues)c[d.GetTag()]=a.GetInterpClientState(d);b[a.GetId()]={nid:a.GetNid(),latency:a.GetLatency(),pdv:a.GetPdv(),clientState:c}}return b}_GetRegisteredObjectRuntimeData(){const b={};for(const a of this._allRegisteredObjects)b[a.GetRoId()]=a.GetRuntimeData();return b}async SendUpdate(b){this.IsHost()?(await this._SendHostUpdate(b),this._SendHostEvents(b)):
await this._SendClientUpdate(b)}async _OnBeforeClientUpdate(){const b=await this.PostToRuntimeAsync("before-client-update");for(const a of b.clientStateUpdates)this.SetClientState(a.tag,a.value)}async _SendClientUpdate(b){this.IsReadyForInput()&&await this._OnBeforeClientUpdate();if(this._selfPeer&&this._receivedClientValues){var a=this._dataView,c=0,d=this._allClientValues,e=this._selfPeer.GetLocalClientState(),f=b-this._selfPeer.GetLastStateChange(),g=b-this._selfPeer.GetLastStateTransmit();if(100>
f||(1E3>f?95<=g:495<=g)){a.setFloat64(c,b+this._hostTimeDiff);c+=8;a.setUint8(c,d.length);c+=1;for(let h=0,k=d.length;h<k;++h)f=d[h],g=0,h<e.length&&(g=f.Clamp(e[h])),c=f.Write(a,c,g);this._selfPeer._SetLastStateTransmit(b);this._hostPeer.Send("u",this._dataBuffer.slice(0,c))}}}async _SendHostUpdate(b){const a=this._dataView;let c=0,d=0;const e=await this.PostToRuntimeAsync("get-object-info",{ros:this._allRegisteredObjects.map(f=>f.GetRuntimeInfoRequest())});for(const f of this._allRegisteredObjects){const g=
f.GetRoId();e.hasOwnProperty(g)&&(f.UpdateData(e[g],b),0<f.GetNumberToTransmit()&&d++)}if(0!==d){a.setFloat64(c,b);c+=8;a.setUint16(c,d);c+=2;for(const f of this._allRegisteredObjects)0<f.GetNumberToTransmit()&&(c=f.WriteData(a,c,b));this.HostBroadcast("u",this._dataBuffer.slice(0,c),0)}}_SendHostEvents(b){const a=this._dataView;let c=0,d=0;for(const e of this._allRegisteredObjects)e.GetDeadNids().length&&d++;if(0!==d){a.setFloat64(c,b);c+=8;a.setUint16(c,d);c+=2;for(const e of this._allRegisteredObjects)if(b=
e.GetDeadNids(),b.length){a.setUint16(c,e.GetNid());c+=2;a.setUint16(c,b.length);c+=2;for(const f of b)a.setUint16(c,f),c+=2;b.length=0}this.HostBroadcast("r",this._dataBuffer.slice(0,c),C3Peer$jscomp$1.FLAG_HOST_UPDATE_TYPE)}}AddHostTime(b,a,c,d){if(!this.IsHost()){this._targetSimDelay=d+this._clientDelay;b=b+c-a;0===this._lastTimeDiffs.length&&(this._hostTimeDiff=b,this._simDelay=this._targetSimDelay);this._lastTimeDiffs.push(b);30<this._lastTimeDiffs.length&&this._lastTimeDiffs.shift();tempArray$jscomp$1.push(...this._lastTimeDiffs);
tempArray$jscomp$1.sort((e,f)=>e-f);b=0;a=tempArray$jscomp$1.length;4<=tempArray$jscomp$1.length&&6>=tempArray$jscomp$1.length?(++b,--a):6<tempArray$jscomp$1.length&&19>=tempArray$jscomp$1.length?(b+=2,a-=2):19<tempArray$jscomp$1.length&&(b+=5,a-=5);c=0;for(d=b;d<a;++d)c+=tempArray$jscomp$1[d];this._targetHostTimeDiff=c/(a-b);tempArray$jscomp$1.length=0}}GetSimulationTime(){return this.IsHost()?performance.now()-this._clientDelay:performance.now()+this._hostTimeDiff-this._simDelay}GetHostTime(){return this.IsHost()?
performance.now():performance.now()+this._hostTimeDiff}GetHostInputArrivalTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff+this._simDelay}SetClientState(b,a){if(!this.IsHost()&&this._selfPeer&&this._receivedClientValues&&(b=this._clientValuesByTag.get(b))){b=b.GetIndex();var c=this._selfPeer.GetLocalClientState();c.length<b+1&&(c.length=b+1);c[b]!==a&&(c[b]=a,this._selfPeer._SetLastStateChange(performance.now()))}}AddClientInputValue(b,a,c){a=new C3NetValue$jscomp$2(this._allClientValues.length,
c,a,b,null);this._clientValuesByTag.set(b,a);this._allClientValues.push(a)}GetClientValues(){return this._allClientValues}GetClientValuesJson(){const b=[];for(const a of this._allClientValues)b.push({tag:a.GetTag(),precision:a.GetPrecision(),interp:a.GetInterp()});return b}MapClientValues(b){this._clientValuesByTag.clear();this._allClientValues.length=0;for(let c=0,d=b.length;c<d;++c){var a=b[c];a=new C3NetValue$jscomp$2(c,a.interp,a.precision,a.tag,null);this._clientValuesByTag.set(a.GetTag(),a);
this._allClientValues.push(a)}this._receivedClientValues=!0}RemoveObjectId(b){for(const a of this._allRegisteredObjects)a.RemoveObjectId(b)}peers(){return this._allPeers}GetPeerCount(){return this.IsInRoom()?this._allPeers.length:0}GetPeerAt(b){b=Math.floor(b);return!this.IsInRoom()||0>b||b>=this._allPeers.length?null:this._allPeers[b]}IsReadyForInput(){return this.IsInRoom()?this.IsHost()?!0:0!==this._targetHostTimeDiff:!1}SetBandwidthSettings(b,a){this.IsInRoom()||(this._peerUpdateRateSec=this._hostUpdateRateSec=
b,this._clientDelay=a)}_OnPeerOpen(b){this.PostToRuntime("peer-open",{id:b.GetId(),alias:b.GetAlias()})}OnPeerSendMessage(b){const a=b.tag;var c=b.message;const d=b.transmissionMode,e=b.contentMode;if(b=this.GetPeerById(b.id))"s"===e&&c instanceof ArrayBuffer?b.Send(d,c,C3Peer$jscomp$1.FLAG_SCRIPT_DATA):(c={c:"m",cm:e,m:c},"e"===e&&(c.t=a),b.Send(d,JSON.stringify(c)))}_OnPeerClose(b,a){this.PostToRuntime("peer-close",{id:b.GetId(),alias:b.GetAlias(),reason:a||"unknown"})}_OnPeerError(b,a){console.error(`[Multiplayer] Peer '${b.GetAlias()}' (${b.GetId()}) error: `,
a)}_OnPeerMessage(b,a,c){b=a.f||b.GetId();this.PostToRuntime("peer-message",{tag:a.t,fromId:b,fromAlias:this.GetAliasFromId(b),transmissionMode:c,content:a.m,contentMode:a.cm||"e"})}_OnPeerBinaryMessage(b,a,c){b=b.GetId();this.PostToRuntime("peer-message",{fromId:b,fromAlias:this.GetAliasFromId(b),transmissionMode:c,content:a,contentMode:"s"})}_OnInstanceDestroyed(b,a,c){this.PostToRuntime("instance-destroyed",{roId:b.GetRoId(),nid:a,timestamp:c})}OnKickPeer(b){if(this.IsHost()){var a=b.reason;(b=
this.GetPeerById(b.id))&&b.Remove(a,!0)}}OnWasKicked(){this.PostToRuntime("peer-kicked")}StatIncOutboundCount(){this._stats.outboundCount++}StatAddOutboundBandwidthCount(b){this._stats.outboundBandwidthCount+=GetDataSize(b)}StatAddOutboundDecompressedBandwidthCount(b){this._stats.outboundDecompressedBandwidthCount+=GetDataSize(b)}StatIncInboundCount(){this._stats.inboundCount++}StatAddInboundBandwidthCount(b){this._stats.inboundBandwidthCount+=GetDataSize(b)}StatAddInboundDecompressedBandwidthCount(b){this._stats.inboundDecompressedBandwidthCount+=
GetDataSize(b)}SetClientDelay(b){this._clientDelay=b}GetClientDelay(){return this._clientDelay}SetPeerUpdateRateSec(b){this._peerUpdateRateSec=b}GetPeerUpdateRateSec(){return this._peerUpdateRateSec}OnSyncObject(b){const a=b.data,c=b.precision,d=b.bandwidth;for(const e of b.objectClasses)b=new self.C3RegisteredObject(this,e.roId,e.sid,d),1===a?(b.AddValue(1,c,"x"),b.AddValue(1,c,"y")):2===a?b.AddValue(2,c,"a"):3===a&&(b.AddValue(1,c,"x"),b.AddValue(1,c,"y"),b.AddValue(2,c,"a"))}Alert(b){alert(b.message)}OnSyncInstVar(b){const a=
b.precision,c=b.interp,d=b.cvt;for(const e of b.syncData)this._registeredObjectsByRoId.get(e.roId).AddValue(c,a,"iv",e.varIndex,d)}OnAssociateObject(b){var a=b.peerId;const c=b.instUid;b=this._registeredObjectsByRoId.get(b.roId);a=this._peersById.get(a);b&&a&&this.IsHost()&&b.OverrideNid(c,a.GetNid())}OnRemoveNetInsts(b){for(const [a,c]of Object.entries(b))if(b=this._registeredObjectsByRoId.get(parseInt(a,10)))for(const d of c)b.RemoveObjectNid(d)}OnRemoveObjectNid(b){const a=b.nid;(b=this._registeredObjectsByRoId.get(b.roId))&&
b.RemoveObjectNid(a)}GetLocalSupportedCompressionFormats(){return localSupportedCompressionFormats}});
